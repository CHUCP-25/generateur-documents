<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Documents CHUSM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dubai:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Thème professionnel simple */
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        .professional-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .professional-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        .professional-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .professional-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .professional-btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .professional-btn-secondary:hover {
            background: #4b5563;
        }

        /* Styles pour les formulaires */
        .form-container-wrapper {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            color: #374151;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .form-container-wrapper h1, .form-container-wrapper h2 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        .form-container-wrapper .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-container-wrapper label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-container-wrapper input[type="text"],
        .form-container-wrapper input[type="date"],
        .form-container-wrapper input[type="time"],
        .form-container-wrapper textarea,
        .form-container-wrapper select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: white;
            color: #374151;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-container-wrapper input:focus,
        .form-container-wrapper textarea:focus,
        .form-container-wrapper select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-container-wrapper input[type="text"]::placeholder,
        .form-container-wrapper textarea::placeholder {
            color: #9ca3af;
        }
        
        .form-container-wrapper input[type="radio"] {
            margin-right: 8px;
        }

        .form-container-wrapper button, 
        .form-container-wrapper .add-member, 
        .form-container-wrapper .add-piece {
            background-color: #3b82f6;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: block;
            margin: 20px auto 0 auto;
            transition: background-color 0.3s ease;
        }
        
        .form-container-wrapper button:hover, 
        .form-container-wrapper .add-member:hover, 
        .form-container-wrapper .add-piece:hover {
            background-color: #2563eb;
        }
        
        .form-container-wrapper .remove-member, 
        .form-container-wrapper .remove-piece {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            height: 28px;
            width: 28px;
            text-align: center;
            font-size: 18px;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }
        
        .form-container-wrapper .remove-member:hover, 
        .form-container-wrapper .remove-piece:hover {
            background-color: #dc2626;
        }
        
        .form-container-wrapper .member-item, 
        .form-container-wrapper .piece-item {
            display: flex;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .form-container-wrapper .member-item input, 
        .form-container-wrapper .piece-item input,
        .form-container-wrapper .member-item select {
            flex-grow: 1;
        }

        /* Styles pour la zone de rendu PDF */
        .pdf-render-area {
            position: absolute;
            left: -9999px;
            top: auto;
            width: 210mm;
            background: white;
            color: #000;
        }
        
        .bordereau-content-pdf {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            color: #000;
            line-height: 1.3;
            width: 100%;
            box-sizing: border-box;
            padding: 15mm;
            position: relative;
            min-height: 270mm;
            display: flex;
            flex-direction: column;
        }
        
        .bordereau-content-pdf .header-pdf {
            text-align: center;
            margin-bottom: 5mm;
            flex-shrink: 0;
        }
        
        .bordereau-content-pdf .header-pdf img {
            max-width: 180mm; 
            height: auto; 
            display: block; 
            margin: 0 auto 10px;
        }
        
        .bordereau-content-pdf .header-pdf p { 
            margin: 1px 0; 
            font-size: 11pt; 
        }
        
        .bordereau-content-pdf .header-pdf p strong { 
            font-weight: bold; 
        }
        
        .bordereau-content-pdf table {
            width: 100%; 
            border-collapse: collapse; 
            border: 1px solid #000;
            table-layout: fixed; 
            margin-top: 10px; 
            margin-bottom: 20px;
        }
        
        .bordereau-content-pdf th, 
        .bordereau-content-pdf td {
            border: 1px solid #000; 
            padding: 6px; 
            text-align: left;
            vertical-align: top; 
            font-size: 10pt; 
            word-wrap: break-word;
        }
        
        .bordereau-content-pdf th { 
            background-color: #f2f2f2; 
            font-weight: bold; 
            text-align: center; 
        }
        
        .bordereau-content-pdf .designations { 
            width: 40%; 
        }
        
        .bordereau-content-pdf .nbre { 
            width: 15%; 
            text-align: center;
        }
        
        .bordereau-content-pdf .observations { 
            width: 45%; 
            text-align: justify;
        }
        
        .bordereau-content-pdf ul { 
            list-style-type: disc; 
            margin: 5px 0 5px 20px; 
            padding-left: 0; 
        }
        
        .bordereau-content-pdf li { 
            margin-bottom: 2px; 
        }
        
        .bordereau-content-pdf pre {
            font-family: Arial, sans-serif; 
            font-size: 10pt; 
            margin: 5px 0;
            white-space: pre-wrap; 
            line-height: 1.3; 
            padding-left: 0;
        }
        
        .bordereau-content-pdf strong { 
            font-weight: bold; 
        }
        
        .bordereau-content-pdf .footer-pdf {
            text-align: center; 
            margin-top: auto;
            padding-top: 5mm; 
            width: 100%;
        }
        
        .bordereau-content-pdf .footer-pdf img {
            max-width: 180mm; 
            height: auto; 
            display: block; 
            margin: 0 auto;
        }

        /* Styles pour Convocation */
        #convocation-form-wrapper .generator-container { 
            max-width: 700px; 
            margin: auto; 
        }
        
        #convocation-form-wrapper .section-buttons button {
            background-color: #f3f4f6; 
            padding: 8px 12px; 
            margin-right: 5px;
            border-radius: 5px; 
            cursor: pointer; 
            color: #374151; 
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
        }
        
        #convocation-form-wrapper .section-buttons button.active { 
            background-color: #3b82f6; 
            color: white;
        }
        
        #convocation-form-wrapper .section-buttons button:hover {
            background-color: #e5e7eb;
        }
        
        #convocation-form-wrapper .section-buttons button.active:hover {
            background-color: #2563eb;
        }
        
        #convocation-form-wrapper .recipient-list { 
            margin-top: 10px; 
            max-height: 200px; 
            overflow-y: auto; 
            padding: 10px; 
            background: #f9fafb; 
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        #convocation-form-wrapper .checkbox-group, 
        #convocation-form-wrapper .select-all-group { 
            margin-bottom: 5px; 
            display: flex; 
            align-items: center; 
        }
        
        #convocation-form-wrapper input[type="checkbox"] { 
            margin-right: 8px; 
            width: auto; 
        }

        /* Styles pour Décision */
        #decision-form-wrapper .radio-group { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 10px;
        }
        
        #decision-form-wrapper .radio-option { 
            display: flex; 
            align-items: center; 
        }
        
        #decision-form-wrapper .radio-option input { 
            width: auto; 
            margin-right: 5px; 
        }
        
        #decision-form-wrapper .members-container { 
            margin-top: 15px; 
        }

        /* Styles spécifiques pour le formulaire de demande de complément */
        #complement-form-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            color: #212529;
        }
        
        #complement-form-wrapper .app-header {
            background-color: #4361ee;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        #complement-form-wrapper .app-header img {
            max-width: 700px;
            width: 100%;
            margin-bottom: 15px;
        }
        
        #complement-form-wrapper .app-title {
            font-size: 1.8rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        #complement-form-wrapper .app-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        #complement-form-wrapper .mode-selector {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 15px;
        }
        
        #complement-form-wrapper .mode-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: #f8f9fa;
            color: #212529;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #complement-form-wrapper .mode-btn.active {
            background-color: #4361ee;
            color: white;
        }
        
        #complement-form-wrapper .mode-btn:hover:not(.active) {
            background-color: #e9ecef;
        }
        
        #complement-form-wrapper .content-area {
            padding: 25px;
        }
        
        #complement-form-wrapper .form-section {
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: white;
        }
        
        #complement-form-wrapper .section-title {
            color: #4361ee;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        #complement-form-wrapper .section-title i {
            margin-right: 10px;
        }
        
        #complement-form-wrapper .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        
        #complement-form-wrapper .form-group label {
            font-weight: 500;
            min-width: 180px;
            color: #495057;
        }
        
        #complement-form-wrapper .form-control {
            flex-grow: 1;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
            color: #212529;
        }
        
        #complement-form-wrapper .form-control:focus {
            border-color: #4895ef;
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        #complement-form-wrapper textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        #complement-form-wrapper select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.25rem;
        }
        
        #complement-form-wrapper table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 0 0 1px #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #complement-form-wrapper th, #complement-form-wrapper td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
            vertical-align: top;
            background-color: #f8f9fa;
        }
        
        #complement-form-wrapper th {
            background-color: #e9ecef;
            font-weight: 500;
            color: #495057;
        }
        
        #complement-form-wrapper .conditions-container .condition-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        #complement-form-wrapper .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        #complement-form-wrapper .btn i {
            margin-right: 8px;
        }
        
        #complement-form-wrapper .btn-primary {
            background-color: #4361ee;
            color: white;
        }
        
        #complement-form-wrapper .btn-primary:hover {
            background-color: #3f37c9;
        }
        
        #complement-form-wrapper .btn-success {
            background-color: #4cc9f0;
            color: white;
        }
        
        #complement-form-wrapper .btn-success:hover {
            background-color: #3aa8d8;
        }
        
        #complement-form-wrapper .btn-danger {
            background-color: #f72585;
            color: white;
        }
        
        #complement-form-wrapper .btn-danger:hover {
            background-color: #d61a6f;
        }
        
        #complement-form-wrapper .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        #complement-form-wrapper .btn-block {
            display: block;
            width: 100%;
        }
        
        #complement-form-wrapper .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        #complement-form-wrapper #statusMulti, #complement-form-wrapper #statusSingle {
            text-align: center;
            font-weight: 500;
            color: #4361ee;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        #complement-form-wrapper .error-message {
            color: #f72585;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        #complement-form-wrapper .hidden {
            display: none !important;
        }
        
        #complement-form-wrapper .document-content {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            box-sizing: border-box;
            font-size: 16px;
            line-height: 1.6;
            background: white;
            font-family: Arial, sans-serif;
            color: black;
            position: relative;
        }
        
        #complement-form-wrapper .document-content p {
            margin: 10px 0;
        }
        
        #complement-form-wrapper .document-content .justify-text {
            text-align: justify;
        }
        
        #complement-form-wrapper .document-content ul {
            padding-left: 20px;
        }
        
        #complement-form-wrapper .document-content li {
            text-align: justify;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            #complement-form-wrapper .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #complement-form-wrapper .form-group label {
                min-width: auto;
                margin-bottom: 5px;
            }
            
            #complement-form-wrapper .form-control {
                width: 100%;
            }
            
            #complement-form-wrapper .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            
            #complement-form-wrapper .mode-btn {
                width: 100%;
                max-width: 300px;
            }
            
            #complement-form-wrapper table {
                display: block;
                overflow-x: auto;
            }
        }

        /* Styles pour le rendu PDF de demande de complément */
        .complement-pdf-render-area {
            position: absolute;
            left: -9999px;
            top: auto;
            width: 210mm;
            height: 297mm;
            background: white;
        }
        
        .complement-pdf-content {
            width: 100%;
            height: 100%;
            padding: 20mm;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #000;
            position: relative;
        }
        
        /* Styles pour la nouvelle interface de Décision */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.15);
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #ec4899, #8b5cf6, #6366f1);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .btn-gradient {
            background: linear-gradient(45deg, #6366f1, #8b5cf6, #ec4899);
            background-size: 200% auto;
            color: white;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .btn-gradient:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.5);
        }
        
        .input-glass {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #000000;
            transition: all 0.3s ease;
        }
        
        .input-glass:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }
        
        .input-glass::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }
        
        .radio-glass {
            accent-color: #8b5cf6;
        }
        
        .section-divider {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);
            margin: 1.5rem 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease forwards;
        }
        
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        .delay-4 { animation-delay: 0.4s; }
        .delay-5 { animation-delay: 0.5s; }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.9); }
        }

        @keyframes blink {
            0%, 100% { background-color: rgba(255, 0, 0, 0.1); }
            50% { background-color: rgba(255, 0, 0, 0.3); }
        }
        
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .animate-fade-out { animation: fadeOut 0.3s ease forwards; }
        .animate-blink { animation: blink 0.5s ease 3; }
        
        .selected-member {
            background-color: rgba(167, 243, 208, 0.3) !important;
        }
        
        .rotate-45 {
            transform: rotate(45deg);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Couleurs différentes pour chaque section */
        .section-1 { background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%); }
        .section-2 { background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(249, 115, 22, 0.05) 100%); }
        .section-3 { background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); }
        .section-4 { background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%); }
        .section-5 { background: linear-gradient(135deg, rgba(168, 85, 247, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%); }
        .section-6 { background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%); }
        .section-7 { background: linear-gradient(135deg, rgba(14, 165, 233, 0.05) 0%, rgba(2, 132, 199, 0.05) 100%); }

        /* Styles pour l'invitation sous-commission */
        .invitation-control-panel {
            width: 50%;
            padding: 20px;
            background-color: #f9f9f9;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            height: 100vh;
        }

        .invitation-preview-area {
            width: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            overflow-y: auto;
            background-color: #fff;
            height: 100vh;
        }

        .invitation-document {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            page-break-after: always;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .document-header {
            text-align: center;
            margin-bottom: 20px;
            margin-top: 5mm;
        }

        .document-header img {
            max-width: 100%;
            height: auto;
            margin-top: -90px;
        }

        .document-footer {
            position: absolute;
            bottom: 10mm;
            left: 0;
            right: 0;
            text-align: center;
        }

        .document-footer img {
            max-width: 100%;
            height: auto;
        }

        .document-content {
            flex: 1;
        }

        .document-header h1 {
            font-size: 14pt;
            margin-bottom: 20px;
        }

        .recipient-info {
            text-align: center;
            margin-bottom: 40px;
        }

        .recipient-name {
            font-weight: bold;
            font-size: 14pt;
            margin-bottom: 5px;
        }

        .recipient-role {
            font-style: italic;
            font-size: 12pt;
        }

        .section-title {
            text-align: center;
            font-weight: bold;
            text-decoration: underline;
            margin: 30px 0 20px 0;
            font-size: 14pt;
        }

        .section-content {
            text-align: justify;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .bold-text {
            font-weight: bold;
        }

        .recipient-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .recipient-selector label {
            margin-right: 10px;
            font-weight: bold;
        }

        .recipient-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }

        .pagination {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            margin: 0 5px;
        }

        .page-info {
            margin: 0 10px;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .invitation-control-panel, .invitation-preview-area {
                width: 100%;
                height: 50%;
            }
            
            .invitation-preview-area {
                justify-content: flex-start;
            }
        }

        /* Styles pour le panneau de contrôle de l'invitation */
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            background-color: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background-color: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .date-time-container {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .date-section, .time-section {
            flex: 1;
        }

        .date-section label, .time-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .date-inputs, .time-inputs {
            display: flex;
            gap: 5px;
        }

        .date-inputs input, .time-inputs input {
            text-align: center;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .recipients-section {
            margin-top: 20px;
        }

        .search-recipient {
            margin-bottom: 15px;
            position: relative;
            display: flex;
            gap: 10px;
        }

        .search-recipient .search-input {
            flex: 2;
        }

        .search-recipient .select-input {
            flex: 1;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .recipients-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: white;
        }

        .recipient-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recipient-item:last-child {
            border-bottom: none;
        }

        .recipient-info-small {
            flex-grow: 1;
        }

        .recipient-name-small {
            font-weight: bold;
        }

        .recipient-role-small {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
        }

        .recipient-actions {
            display: flex;
            gap: 5px;
        }

        .btn {
            padding: 10px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Times New Roman', Times, serif;
            font-size: 1em;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background-color: #1a252f;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-warning {
            background-color: #f39c12;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-small {
            padding: 5px 8px;
            font-size: 0.8em;
        }

        .btn-home {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn-home:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800 font-sans antialiased overflow-x-hidden">
    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Menu principal -->
        <div id="main-menu" class="w-full max-w-6xl">
            <header class="mb-4 text-center">
                <!-- Espace réduit au-dessus des boutons -->
            </header>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-4">
                <div class="professional-card p-4 flex flex-col items-center justify-center transition-all duration-300 cursor-pointer h-32" onclick="handleOptionClick(1)">
                    <div class="bg-blue-100 p-3 rounded-full mb-2 text-blue-600"><i class="fas fa-file-alt text-xl"></i></div>
                    <h3 class="text-sm font-semibold text-center text-gray-800">CONVOCATION</h3>
                </div>
                <div class="professional-card p-4 flex flex-col items-center justify-center transition-all duration-300 cursor-pointer h-32" onclick="handleOptionClick(2)">
                    <div class="bg-purple-100 p-3 rounded-full mb-2 text-purple-600"><i class="fas fa-paper-plane text-xl"></i></div>
                    <h3 class="text-sm font-semibold text-center text-gray-800">BORDEREAU V1</h3>
                </div>
                <div class="professional-card p-4 flex flex-col items-center justify-center transition-all duration-300 cursor-pointer h-32" onclick="handleOptionClick(3)">
                    <div class="bg-green-100 p-3 rounded-full mb-2 text-green-600"><i class="fas fa-file-export text-xl"></i></div>
                    <h3 class="text-sm font-semibold text-center text-gray-800">BORDEREAU FINAL</h3>
                </div>
                <div class="professional-card p-4 flex flex-col items-center justify-center transition-all duration-300 cursor-pointer h-32" onclick="handleOptionClick(4)">
                    <div class="bg-yellow-100 p-3 rounded-full mb-2 text-yellow-600"><i class="fas fa-gavel text-xl"></i></div>
                    <h3 class="text-sm font-semibold text-center text-gray-800">DÉCISION</h3>
                </div>
                <div class="professional-card p-4 flex flex-col items-center justify-center transition-all duration-300 cursor-pointer h-32" onclick="handleOptionClick(5)">
                    <div class="bg-red-100 p-3 rounded-full mb-2 text-red-600"><i class="fas fa-tools text-xl"></i></div>
                    <h3 class="text-sm font-semibold text-center text-gray-800">DEMANDE COMPLÉMENT</h3>
                </div>
                <div class="professional-card p-4 flex flex-col items-center justify-center transition-all duration-300 cursor-pointer h-32" onclick="handleOptionClick(6)">
                    <div class="bg-indigo-100 p-3 rounded-full mb-2 text-indigo-600"><i class="fas fa-envelope-open-text text-xl"></i></div>
                    <h3 class="text-sm font-semibold text-center text-gray-800">INVITATION SOUS-COMMISSION</h3>
                </div>
                <div class="professional-card p-4 flex flex-col items-center justify-center transition-all duration-300 cursor-pointer h-32" onclick="handleOptionClick(7)">
                    <div class="bg-gray-100 p-3 rounded-full mb-2 text-gray-600"><i class="fas fa-wrench text-xl"></i></div>
                    <h3 class="text-sm font-semibold text-center text-gray-800">NOUVEL OUTIL À VENIR</h3>
                </div>
            </div>
        </div>

        <!-- Conteneurs pour les différents formulaires (initialement cachés) -->
        <div id="form-containers" class="hidden w-full max-w-7xl mx-auto professional-card p-8 rounded-2xl mt-10 mb-10 relative">
            <button id="backToMenuBtn" class="btn-home">
                <i class="fas fa-home text-xl"></i>
            </button>

            <!-- Formulaire CONVOCATION -->
            <div id="convocation-form-wrapper" class="hidden form-container-wrapper">
                <h1>Générateur de Convocation</h1>
                <p class="text-center mb-6">Remplissez les informations ci-dessous pour générer les lettres de convocation.</p>
                <form id="convocationFormInternal" onsubmit="return false;">
                    <h2>Informations Destinataires</h2>
                    <div class="form-group">
                        <label>Choisir la section :</label>
                        <div class="section-buttons" id="convocationSectionButtons"></div>
                    </div>
                    <div class="form-group">
                        <label>Sélectionner les destinataires :</label>
                        <div id="convocationRecipients" class="recipient-list">
                            Sélectionnez une section ci-dessus.
                        </div>
                    </div>
                    <h2>Détails de l'Appel d'Offres</h2>
                    <div class="form-group">
                        <label for="convocationV4">N° Appel d'Offres (V4) :</label>
                        <input type="text" id="convocationV4" placeholder="Ex: 02/2228/CHUSM" required>
                    </div>
                    <div class="form-group">
                        <label for="convocationV5">Objet de l'Appel d'Offres (V5) :</label>
                        <textarea id="convocationV5" rows="3" placeholder="Ex: Acquisition de matériel..." required></textarea>
                    </div>
                    <h2>Date et Heure de la Séance</h2>
                    <div class="form-group">
                        <label for="convocationV6">Date d'ouverture (V6) :</label>
                        <input type="date" id="convocationV6" required>
                    </div>
                    <div class="form-group">
                        <label for="convocationV7">Heure d'ouverture (V7) :</label>
                        <input type="time" id="convocationV7" required>
                    </div>
                    <button type="button" id="generateConvocationPdfButton" class="professional-btn">Générer les Convocations PDF</button>
                </form>
            </div>

            <!-- Formulaire BORDEREAU V1 -->
            <div id="bordereau-v1-form-wrapper" class="hidden form-container-wrapper">
                <h1>Générateur de Bordereau d'Envoi V1</h1>
                <div class="form-group">
                    <label for="commissionTitleV1">Titre de la commission :</label>
                    <input type="text" id="commissionTitleV1" value="Membres de la commission d'appel d'offres">
                </div>
                <div class="form-group">
                    <label for="offerNumberV1">Numéro de l'appel d'offres :</label>
                    <input type="text" id="offerNumberV1" value="N°01/2024/CHUSM">
                </div>
                <div class="form-group">
                    <label>Membres de la commission :</label>
                    <div class="members-list" id="membersListV1">
                        <div class="member-item"><input type="text" class="member-name" value="Pr. ARRAYHANI Mohamed"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. KERBID El Mehdi"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. HOUCINE JABBARI"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="Mme. RAMI Rajaa"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. OUAYA Laheen"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. BELLA Abdoullah"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. EL BAAMRANI Said"><button type="button" class="remove-member">×</button></div>
                    </div>
                    <button type="button" class="add-member" id="addMemberV1">Ajouter un membre</button>
                </div>
                <div class="form-group">
                    <label for="offerObjectV1">Objet de l'appel d'offres :</label>
                    <textarea id="offerObjectV1">ACHAT DE LA LITERIE POUR LES BESOINS DE L'INTERNAT RELEVANT DU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (Lot Unique)</textarea>
                </div>
                <div class="form-group">
                    <label>Le dossier d'appel d'offres comprend :</label>
                    <div class="pieces-list" id="piecesListV1">
                        <div class="piece-item"><input type="text" class="piece-name" value="CPS"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Le bordereau des prix détail estimatif"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Règlement de la consultation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Estimation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Acte d'Engagement"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Déclaration sur l'Honneur"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Avis d'appel d'offres (Arabe, Français)"><button type="button" class="remove-piece">×</button></div>
                    </div>
                    <button type="button" class="add-piece" id="addPieceV1">Ajouter une pièce</button>
                </div>
                <button id="generateBordereauV1Pdf" class="professional-btn">Générer et Télécharger le PDF V1</button>
                <!-- Zone de rendu PDF pour Bordereau V1 -->
                <div id="pdf-render-area-v1" class="pdf-render-area">
                    <div id="bordereau-content-v1" class="bordereau-content-pdf">
                        <div class="header-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                            <p><strong>AUX</strong></p>
                            <p><strong id="pdf-commission-title-v1"></strong></p>
                            <p><strong id="pdf-numero-ao-header-v1"></strong></p><br>
                            <p><strong>BORDEREAU D'ENVOI</strong></p>
                        </div>
                        <table>
                            <thead><tr><th class="designations">DESIGNATIONS</th><th class="nbre">NBRE</th><th class="observations">OBSERVATIONS</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td class="designations">
                                        <p><strong>Les membres de la commission :</strong></p>
                                        <pre id="pdf-membres-v1"></pre>
                                        <br>
                                        <p><strong>Dossier de l'appel d'offres <span id="pdf-numero-ao-body-v1"></span> comprenant :</strong></p>
                                        <ul id="pdf-pieces-v1"></ul>
                                    </td>
                                    <td class="nbre">Un exemplaire de chaque document</td>
                                    <td class="observations">
                                        <p style="text-align: justify; margin: 0;">
                                            Vous est transmis par voie électronique le Dossier d'appel d'Offres <strong id="pdf-numero-ao-obs-v1"></strong> relatif à : « <strong id="pdf-objet-ao-v1"></strong> », en application du l'alinéa e paragraphe 1 de l'article 20 et de l'alinéa 1 paragraphe 2 de l'article 22 du Décret n° 2-22-431 du 15 chaabane 1444 (8 mars 2023) relatif aux marchés publics, en vous rappelant qu'aux termes de l'articles 22 vous disposez de <strong>6 jours</strong> pour nous faire parvenir vos observations.
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="footer-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire BORDEREAU FINAL -->
            <div id="bordereau-final-form-wrapper" class="hidden form-container-wrapper">
                <h1>Générateur de Bordereau d'Envoi Final</h1>
                 <div class="form-group">
                    <label for="commissionTitleFinal">Titre de la commission :</label>
                    <input type="text" id="commissionTitleFinal" value="Membres de la commission d'appel d'offres">
                </div>
                <div class="form-group">
                    <label for="offerNumberFinal">Numéro de l'appel d'offres :</label>
                    <input type="text" id="offerNumberFinal" value="N°01/2024/CHUSM">
                </div>
                <div class="form-group">
                    <label>Membres de la commission :</label>
                    <div class="members-list" id="membersListFinal">
                        <div class="member-item"><input type="text" class="member-name" value="Pr. ARRAYHANI Mohamed"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. KERBID El Mehdi"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. HOUCINE JABBARI"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="Mme. RAMI Rajaa"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. OUAYA Laheen"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. BELLA Abdoullah"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. EL BAAMRANI Said"><button type="button" class="remove-member">×</button></div>
                    </div>
                    <button type="button" class="add-member" id="addMemberFinal">Ajouter un membre</button>
                </div>
                <div class="form-group">
                    <label for="offerObjectFinal">Objet de l'appel d'offres :</label>
                    <textarea id="offerObjectFinal">ACHAT DE LA LITERIE POUR LES BESOINS DE L'INTERNAT RELEVANT DU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (Lot Unique)</textarea>
                </div>
                <div class="form-group">
                    <label>Le dossier d'appel d'offres comprend :</label>
                    <div class="pieces-list" id="piecesListFinal">
                         <div class="piece-item"><input type="text" class="piece-name" value="CPS"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Le bordereau des prix détail estimatif"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Règlement de la consultation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Estimation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Acte d'Engagement"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Déclaration sur l'Honneur"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Avis d'appel d'offres (Arabe, Français)"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Convocation"><button type="button" class="remove-piece">×</button></div>
                    </div>
                    <button type="button" class="add-piece" id="addPieceFinal">Ajouter une pièce</button>
                </div>
                <button id="generateBordereauFinalPdf" class="professional-btn">Générer et Télécharger le PDF Final</button>
                <!-- Zone de rendu PDF pour Bordereau Final -->
                <div id="pdf-render-area-final" class="pdf-render-area">
                    <div id="bordereau-content-final" class="bordereau-content-pdf">
                        <div class="header-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                            <p><strong>AUX</strong></p>
                            <p><strong id="pdf-commission-title-final"></strong></p>
                            <p><strong id="pdf-numero-ao-header-final"></strong></p><br>
                            <p><strong>BORDEREAU D'ENVOI</strong></p>
                        </div>
                        <table>
                            <thead><tr><th class="designations">DESIGNATIONS</th><th class="nbre">NBRE</th><th class="observations">OBSERVATIONS</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td class="designations">
                                        <p><strong>Les membres de la commission :</strong></p>
                                        <pre id="pdf-membres-final"></pre>
                                        <br>
                                        <p><strong>Dossier de l'appel d'offres <span id="pdf-numero-ao-body-final"></span> comprenant :</strong></p>
                                        <ul id="pdf-pieces-final"></ul>
                                    </td>
                                    <td class="nbre">Un exemplaire de chaque document</td>
                                    <td class="observations">
                                        <p style="text-align: justify; margin: 0;">
                                           Vous est transmis par voie électronique la version définitive du dossier d'appel d'Offres <strong id="pdf-numero-ao-obs-final"></strong> relatif à : « <strong id="pdf-objet-ao-final"></strong> ».
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                         <div class="footer-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire DECISION - NOUVELLE VERSION -->
            <div id="decision-form-wrapper" class="hidden">
                <!-- Main container -->
                <div class="container mx-auto px-4 py-8">
                    <div class="max-w-4xl mx-auto">
                        <!-- Header -->
                        <div class="text-center mb-12 fade-in">
                            <div class="inline-block">
                                <svg class="w-24 h-24 mx-auto text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <h1 class="text-4xl md:text-5xl font-bold mb-4 gradient-text">Décision de la commission</h1>
                        </div>
                        
                        <!-- Main form with glass effect -->
                        <div id="decision-form-content" class="glass-card p-6 md:p-8 mb-8 fade-in delay-1">
                            <!-- Form header -->
                            <div class="flex items-center mb-6">
                                <div class="bg-primary/20 p-3 rounded-full mr-4">
                                    <svg class="w-6 h-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                    </svg>
                                </div>
                                <h2 class="text-2xl font-semibold text-black">Détails de l'appel d'offres</h2>
                            </div>
                            
                            <!-- Form content -->
                            <div class="space-y-6">
                                <!-- Tender number -->
                                <div class="fade-in delay-2">
                                    <label class="block text-sm font-medium text-black/80 mb-2">Numéro d'appel d'offres <span class="text-red-500">*</span></label>
                                    <input type="text" id="tenderNumberDecision" class="input-glass w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary" placeholder="Ex: 02/2025/CHUSM">
                                    <div id="tenderNumberError" class="error-message hidden">Ce champ est obligatoire</div>
                                </div>
                                
                                <!-- Tender type -->
                                <div class="fade-in delay-2">
                                    <label class="block text-sm font-medium text-black/80 mb-2">Type d'appel d'offres</label>
                                    <div class="flex flex-wrap gap-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="nationalDecision" name="tenderTypeDecision" value="national" checked class="radio-glass h-5 w-5">
                                            <span class="ml-2 text-black">National</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="internationalDecision" name="tenderTypeDecision" value="international" class="radio-glass h-5 w-5">
                                            <span class="ml-2 text-black">International</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Tender mode -->
                                <div class="fade-in delay-2">
                                    <label class="block text-sm font-medium text-black/80 mb-2">Mode d'appel d'offres</label>
                                    <div class="flex flex-wrap gap-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="surOffreDecision" name="tenderModeDecision" value="sur offre" checked class="radio-glass h-5 w-5">
                                            <span class="ml-2 text-black">Sur offre de prix</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="majorationDecision" name="tenderModeDecision" value="à majoration" class="radio-glass h-5 w-5">
                                            <span class="ml-2 text-black">À majoration</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Tender object -->
                                <div class="fade-in delay-3">
                                    <label class="block text-sm font-medium text-black/80 mb-2">Objet de l'appel d'offres <span class="text-red-500">*</span></label>
                                    <textarea id="tenderObjectDecision" rows="3" class="input-glass w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary" placeholder="Ex: ACHAT DE MEDICAMENTS POUR LE CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (220 LOTS)"></textarea>
                                    <div id="tenderObjectError" class="error-message hidden">Ce champ est obligatoire</div>
                                </div>
                                
                                <hr class="section-divider fade-in delay-3">
                                
                                <!-- President and suppleant -->
                                <div class="grid md:grid-cols-2 gap-6 fade-in delay-4">
                                    <div>
                                        <label class="block text-sm font-medium text-black/80 mb-2">Président</label>
                                        <select id="presidentDecision" class="input-glass w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary">
                                            <option value="Dr. BATAAL Ali : Directeur Général du Centre Hospitalo-Universitaire Souss-Massa PI">Dr. BATAAL Ali : Directeur Général du Centre Hospitalo-Universitaire Souss-Massa PI</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-black/80 mb-2">Suppléant</label>
                                        <select id="suppleantDecision" class="input-glass w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary">
                                            <option value="M. KERBID El Mehdi : Secrétaire Général du CHU Souss-Massa">M. KERBID El Mehdi : Secrétaire Général du CHU Souss-Massa</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <hr class="section-divider fade-in delay-4">
                                
                                <!-- Members section -->
                                <div class="fade-in delay-5">
                                    <label class="block text-sm font-medium text-black/80 mb-2">MEMBRES</label>
                                    
                                    <!-- Selected members -->
                                    <div id="selectedMembersContainerDecision" class="space-y-3 mb-6">
                                        <!-- Selected members will appear here -->
                                    </div>
                                    
                                    <!-- Member sections -->
                                    <div id="sectionsContainerDecision" class="space-y-4">
                                        <!-- Sections will be added here dynamically -->
                                    </div>
                                    
                                    <!-- Add member button -->
                                    <button id="addMemberBtnDecision" class="btn-gradient px-6 py-3 rounded-lg font-medium mt-4 w-full md:w-auto flex items-center justify-center gap-2">
                                        <i class="fas fa-user-plus"></i> Ajouter un nouveau membre
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error messages container -->
                        <div id="globalErrors" class="mb-4"></div>
                        
                        <!-- Generate button -->
                        <div class="fade-in delay-5">
                            <button id="decisionGenerateBtn" class="btn-gradient px-8 py-4 rounded-xl font-semibold text-lg w-full flex items-center justify-center gap-3">
                                <i class="fas fa-file-pdf"></i> Générer la Décision en PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire DEMANDE COMPLEMENT - CORRIGÉ -->
            <div id="complement-form-wrapper" class="hidden">
                <div class="app-header">
                    <h1 class="app-title">Générateur de Demandes de Complément</h1>
   
                </div>

                <div class="mode-selector">
                    <button id="multiLotBtn" class="mode-btn active">
                        <i class="fas fa-copy mr-2"></i> DEMANDE DE COMPLEMENT-ALLOTI
                    </button>
                    <button id="singleLotBtn" class="mode-btn">
                        <i class="fas fa-file-alt mr-2"></i> DEMANDE DE COMPLEMENT-LOT UNIQUE
                    </button>
                </div>

                <div class="content-area">
                    <!-- Multi-lot Section -->
                    <div id="multiLotSection">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-info-circle mr-2"></i> Informations sur l'Appel d'Offres</h2>
                            <div class="form-group">
                                <label for="refNumber">N° d'appel d'offres :</label>
                                <input type="text" id="refNumber" class="form-control" value="02/2025/CHUSM">
                            </div>
                            <div class="form-group">
                                <label for="offerType">Type d'appel d'offres :</label>
                                <select id="offerType" class="form-control">
                                    <option value="national">National</option>
                                    <option value="international" selected>International</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="offerObject">Objet de l'appel d'offres :</label>
                                <textarea id="offerObject" class="form-control">ACHAT DE MÉDICAMENTS POUR LE CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (220 LOTS)</textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-building mr-2"></i> Sociétés à Notifier</h2>
                            <table id="societesTable">
                                <thead>
                                    <tr>
                                        <th style="width: 18%;">Nom Société</th>
                                        <th style="width: 15%;">Lots Concernés</th>
                                        <th style="width: 55%;">Conditions à Compléter</th>
                                        <th style="width: 10%;">NB facultatif</th>
                                        <th style="width: 2%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="societesTableBody"></tbody>
                            </table>
                            <button id="addSocieteBtn" type="button" class="btn btn-primary" style="margin-top: 20px;">
                                <i class="fas fa-plus mr-2"></i> Ajouter une société
                            </button>
                        </div>

                        <div class="action-buttons">
                            <button id="generateMultiBtn" class="btn btn-success">
                                <i class="fas fa-file-pdf mr-2"></i> Générer le PDF pour toutes les sociétés
                            </button>
                        </div>
                        <div id="statusMulti"></div>
                    </div>

                    <!-- Single-lot Section -->
                    <div id="singleLotSection" class="hidden">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-info-circle mr-2"></i> Informations de base</h2>
                            <div class="form-group">
                                <label for="singleCompanyName">Nom de la société :</label>
                                <input type="text" id="singleCompanyName" class="form-control" placeholder="Ex: AAAA">
                            </div>
                            <div class="form-group">
                                <label for="singleRefNumber">Numéro d'appel d'offres :</label>
                                <input type="text" id="singleRefNumber" class="form-control" placeholder="Ex: 01/2025/CHUSM">
                            </div>
                            <div class="form-group">
                                <label for="singleOfferType">Type d'appel d'offres :</label>
                                <select id="singleOfferType" class="form-control">
                                    <option value="national">National</option>
                                    <option value="international" selected>International</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pricingType">Type de marché :</label>
                                <select id="pricingType" class="form-control">
                                    <option value="sur offres de prix">Sur offres de prix</option>
                                    <option value="à majoration">À majoration</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="singleOfferObject">Objet de l'appel d'offres :</label>
                                <textarea id="singleOfferObject" class="form-control" placeholder="Ex: ACHAT DES PRODUITS ET CONSOMMABLES DE STERILISATION..."></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-tasks mr-2"></i> Conditions à compléter</h2>
                            <div id="singleConditionsContainer" class="condition-container">
                                <div class="condition-item">
                                    <input type="text" class="form-control condition-input" value="Compléter le dossier Administratif conformément à l'article N°05 du règlement de consultation">
                                    <button type="button" class="btn btn-danger btn-sm remove-condition">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="condition-item">
                                    <input type="text" class="form-control condition-input" value="Produire les échantillons et la liste de colisage cachetés et portant le N° d'appel d'offres accompagnés d'une copie certifiée conforme à l'originale du certificat d'enregistrement des dispositifs médicaux (CEDM) ou de négativité">
                                    <button type="button" class="btn btn-danger btn-sm remove-condition">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" id="addConditionBtn" class="btn btn-primary">
                                <i class="fas fa-plus mr-2"></i> Ajouter une autre condition
                            </button>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-sticky-note mr-2"></i> Note complémentaire (facultative)</h2>
                            <textarea id="singleNote" class="form-control" placeholder="Ex: Les échantillons doivent être déposés à..."></textarea>
                        </div>

                        <div class="action-buttons">
                            <button id="generateSingleBtn" class="btn btn-success">
                                <i class="fas fa-file-pdf mr-2"></i> Générer et Télécharger le PDF
                            </button>
                        </div>
                        <div id="statusSingle"></div>
                    </div>
                </div>
            </div>

            <!-- Formulaire INVITATION SOUS-COMMISSION -->
            <div id="invitation-sous-commission-wrapper" class="hidden" style="display: flex; height: 80vh;">
                <div class="invitation-control-panel">
                    <h2>Configuration de l'Invitation</h2>
                    
                    <div class="mode-selector">
                        <div class="mode-btn active" id="btnLotUnique">Appel d'Offres Lot Unique</div>
                        <div class="mode-btn" id="btnAlloti">Appel d'Offres Alloti</div>
                    </div>
                    
                    <!-- Section pour le mode Lot Unique -->
                    <div id="sectionLotUnique">
                        <h3>Destinataires</h3>
                        
                        <div class="recipients-section">
                            <div class="form-group search-recipient">
                                <div class="search-input">
                                    <label for="searchRecipient">Rechercher un destinataire:</label>
                                    <input type="text" id="searchRecipient" placeholder="Tapez pour rechercher...">
                                    <div class="suggestions" id="suggestionsLotUnique"></div>
                                </div>
                                <div class="select-input">
                                    <label for="selectRecipient">Sélectionner un destinataire:</label>
                                    <select id="selectRecipient">
                                        <option value="">Choisir un destinataire</option>
                                        <!-- Options seront ajoutées dynamiquement -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="recipientName">Nom du Destinataire:</label>
                                <input type="text" id="recipientName" placeholder="Nom complet">
                            </div>
                            
                            <div class="form-group">
                                <label for="recipientRole">Fonction/Rôle:</label>
                                <input type="text" id="recipientRole" placeholder="Fonction et service">
                            </div>
                            
                            <button class="btn" id="addRecipient">Ajouter Destinataire</button>
                            
                            <div class="recipients-list" id="recipientsList">
                                <!-- Liste des destinataires ajoutés -->
                            </div>
                        </div>
                        
                        <h3>Paramètres de l'invitation</h3>
                        
                        <div class="form-group">
                            <label for="reference">Numéro de l'Appel d'Offres:</label>
                            <input type="text" id="reference" value="03/2025/CHUSM">
                        </div>
                        
                        <div class="form-group">
                            <label for="object">Objet du Marché:</label>
                            <textarea id="object">ACHAT DE FOURNITURE DE COUCHAGE DESTINEE AU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (Lot Unique)</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="offerType">Type d'Appel d'Offres:</label>
                            <select id="offerType">
                                <option value="National">National</option>
                                <option value="International" selected>International</option>
                            </select>
                        </div>
                        
                        <div class="date-time-container">
                            <div class="date-section">
                                <label>DATE :</label>
                                <div class="date-inputs">
                                    <input type="text" id="day" placeholder="JJ" maxlength="2" value="17" size="2">
                                    <span>/</span>
                                    <input type="text" id="month" placeholder="MM" maxlength="2" value="10" size="2">
                                    <span>/</span>
                                    <input type="text" id="year" placeholder="AAAA" maxlength="4" value="2025" size="4">
                                </div>
                            </div>
                            <div class="time-section">
                                <label>HEURE :</label>
                                <div class="time-inputs">
                                    <input type="text" id="hour" placeholder="HH" maxlength="2" value="11" size="2">
                                    <span>:</span>
                                    <input type="text" id="minute" placeholder="MM" maxlength="2" value="00" size="2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="location">Lieu:</label>
                            <textarea id="location">siège de la Direction Générale du Centre Hospitalo-Universitaire de Souss-Massa, sis à la Route Nationale N°1, Agadir</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="examenType">Examen de :</label>
                            <select id="examenType">
                                <option value="de l'offre technique">de l'offre technique</option>
                                <option value="des documents techniques">des documents techniques</option>
                                <option value="des échantillons">des échantillons</option>
                                <option value="des attestations d'analyses et de contrôle qualité et les échantillons" selected>des attestations d'analyses et de contrôle qualité et les échantillons</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-success" id="generateAllPdf">Générer tous les PDF</button>
                            <button class="btn" id="viewAll">Visualiser tout</button>
                        </div>
                    </div>
                    
                    <!-- Section pour le mode Alloti -->
                    <div id="sectionAlloti" class="hidden">
                        <h3>Destinataires</h3>
                        
                        <div class="recipients-section">
                            <div class="form-group search-recipient">
                                <div class="search-input">
                                    <label for="searchRecipientAlloti">Rechercher un destinataire:</label>
                                    <input type="text" id="searchRecipientAlloti" placeholder="Tapez pour rechercher...">
                                    <div class="suggestions" id="suggestionsAlloti"></div>
                                </div>
                                <div class="select-input">
                                    <label for="selectRecipientAlloti">Sélectionner un destinataire:</label>
                                    <select id="selectRecipientAlloti">
                                        <option value="">Choisir un destinataire</option>
                                        <!-- Options seront ajoutées dynamiquement -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="recipientNameAlloti">Nom du Destinataire:</label>
                                <input type="text" id="recipientNameAlloti" placeholder="Nom complet">
                            </div>
                            
                            <div class="form-group">
                                <label for="recipientRoleAlloti">Fonction/Rôle:</label>
                                <input type="text" id="recipientRoleAlloti" placeholder="Fonction et service">
                            </div>
                            
                            <button class="btn" id="addRecipientAlloti">Ajouter Destinataire</button>
                            
                            <div class="recipients-list" id="recipientsListAlloti">
                                <!-- Liste des destinataires ajoutés -->
                            </div>
                        </div>
                        
                        <h3>Paramètres de l'invitation</h3>
                        
                        <div class="form-group">
                            <label for="lots">Les lots à examiner:</label>
                            <input type="text" id="lots" placeholder="Ex: 39, 40" value="39, 40">
                            <div class="error-message" id="lotsError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="referenceAlloti">Numéro de l'Appel d'Offres:</label>
                            <input type="text" id="referenceAlloti" value="03/2025/CHUSM">
                        </div>
                        
                        <div class="form-group">
                            <label for="objectAlloti">Objet du Marché:</label>
                            <textarea id="objectAlloti">ACHAT DE FOURNITURE DE COUCHAGE DESTINEE AU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="offerTypeAlloti">Type d'Appel d'Offres:</label>
                            <select id="offerTypeAlloti">
                                <option value="National">National</option>
                                <option value="International" selected>International</option>
                            </select>
                        </div>
                        
                        <div class="date-time-container">
                            <div class="date-section">
                                <label>DATE :</label>
                                <div class="date-inputs">
                                    <input type="text" id="dayAlloti" placeholder="JJ" maxlength="2" value="17" size="2">
                                    <span>/</span>
                                    <input type="text" id="monthAlloti" placeholder="MM" maxlength="2" value="09" size="2">
                                    <span>/</span>
                                    <input type="text" id="yearAlloti" placeholder="AAAA" maxlength="4" value="2025" size="4">
                                </div>
                            </div>
                            <div class="time-section">
                                <label>HEURE :</label>
                                <div class="time-inputs">
                                    <input type="text" id="hourAlloti" placeholder="HH" maxlength="2" value="11" size="2">
                                    <span>:</span>
                                    <input type="text" id="minuteAlloti" placeholder="MM" maxlength="2" value="00" size="2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="locationAlloti">Lieu:</label>
                            <textarea id="locationAlloti">siège de la Direction Générale du Centre Hospitalo-Universitaire de Souss-Massa</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="examenTypeAlloti">Examen de :</label>
                            <select id="examenTypeAlloti">
                                <option value="de l'offre technique">de l'offre technique</option>
                                <option value="des documents techniques" selected>des documents techniques</option>
                                <option value="des échantillons">des échantillons</option>
                                <option value="des attestations d'analyses et de contrôle qualité et les échantillons">des attestations d'analyses et de contrôle qualité et les échantillons</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-success" id="generateAllPdfAlloti">Générer tous les PDF</button>
                            <button class="btn" id="viewAllAlloti">Visualiser tout</button>
                        </div>
                    </div>
                </div>
                
                <!-- Zone de prévisualisation -->
                <div class="invitation-preview-area">
                    <div class="preview-container">
                        <div class="recipient-selector">
                            <label for="previewRecipient">Sélectionner un destinataire:</label>
                            <select id="previewRecipient">
                                <!-- Options seront ajoutées dynamiquement -->
                            </select>
                        </div>
                        
                        <div class="pagination" id="pagination" style="display: none;">
                            <button class="btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                            <span class="page-info" id="pageInfo">Page 1 sur 1</span>
                            <button class="btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        
                        <div class="invitation-document" id="invitationDocument">
                            <!-- Contenu de l'invitation généré dynamiquement -->
                        </div>
                        
                        <div class="error-message" id="globalError"></div>
                        
                        <button class="btn btn-success" id="generatePdf">Télécharger en PDF</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Make jsPDF globally available
        window.jsPDF = window.jspdf.jsPDF;

        // --- Gestion de la navigation principale ---
        const mainMenu = document.getElementById('main-menu');
        const formContainersDiv = document.getElementById('form-containers');
        const backToMenuBtn = document.getElementById('backToMenuBtn');

        function handleOptionClick(optionNumber) {
            const allFormWrappers = formContainersDiv.querySelectorAll(':scope > div');
            allFormWrappers.forEach(div => div.classList.add('hidden'));

            if (optionNumber === 5) { 
                mainMenu.classList.add('hidden');
                formContainersDiv.classList.remove('hidden');
                backToMenuBtn.classList.remove('hidden');
                document.getElementById('complement-form-wrapper').classList.remove('hidden');
                initializeComplementForm();
            } else if (optionNumber === 6) {
                // Invitation sous-commission
                mainMenu.classList.add('hidden');
                formContainersDiv.classList.remove('hidden');
                backToMenuBtn.classList.remove('hidden');
                document.getElementById('invitation-sous-commission-wrapper').classList.remove('hidden');
                initializeInvitationSousCommission();
            } else if (optionNumber === 7) {
                // Nouvel outil à venir - afficher un message
                alert("Nouvel outil à venir - en cours de développement");
            } else {
                mainMenu.classList.add('hidden');
                formContainersDiv.classList.remove('hidden');
                backToMenuBtn.classList.remove('hidden');

                let targetWrapperId = '';
                switch(optionNumber) {
                    case 1: targetWrapperId = 'convocation-form-wrapper'; initializeConvocationForm(); break;
                    case 2: targetWrapperId = 'bordereau-v1-form-wrapper'; initializeBordereauV1Form(); break;
                    case 3: targetWrapperId = 'bordereau-final-form-wrapper'; initializeBordereauFinalForm(); break;
                    case 4: targetWrapperId = 'decision-form-wrapper'; initializeDecisionCommissionForm(); break;
                }
                if (targetWrapperId) {
                    document.getElementById(targetWrapperId).classList.remove('hidden');
                }
            }
        }
        
        if (backToMenuBtn) {
            backToMenuBtn.addEventListener('click', () => {
                formContainersDiv.classList.add('hidden');
                mainMenu.classList.remove('hidden');
                backToMenuBtn.classList.add('hidden');
            });
        }

        // --- LOGIQUE POUR INVITATION SOUS-COMMISSION ---
  
        function initializeInvitationSousCommission() {
    // Initialisation de jsPDF
    const { jsPDF } = window.jspdf;
    
    // Données des destinataires préchargés avec "Professeur en" ajouté
    const preloadedRecipients = [
        { name: "Pr. ABBAOUI SANAE", role: "Professeur en Anatomie Pathologique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ABDALA SELMA", role: "Professeur en Pneumologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ADALI NAWAL", role: "Professeur en Neurologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AJDI FARIDA", role: "Professeur en Endocrinologie et maladies métaboliques au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AKEBOUR KHADIJA", role: "Professeur en Psychiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AMAOUI BOUCHRA", role: "Professeur en Radiothérapie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AMMOR FATIMA ZAHRA", role: "Professeur en Chirurgie Thoracique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AMMOURI SAFAA", role: "Professeur en Gynécologie Obstétrique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ANIBAR SARA", role: "Professeur en Néphrologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AQODAD NOURDIN", role: "Professeur en Gastro-entérologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ARRAYHANI MOHAMED", role: "Professeur en Néphrologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AZOUAOUI M'BAREK", role: "Professeur en Gastro-entérologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BADDOUH NAIMA", role: "Professeur en Pédiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BAKKALI ABDERRAHMANE", role: "Professeur en Chirurgie cardiovasculaire au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. AHMED EL ADAOUI", role: "Professeur en Chirurgie cardiovasculaire au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BENHADDA HICHAM", role: "Professeur en Médecine Légale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BENHOUMMAD OTHMANE", role: "Professeur en ORL au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BENLENDA OTHMANE", role: "Professeur en Anesthésie réanimation au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BENMASSAOUD ZINEB", role: "Professeur en Chirurgie Pédiatrique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BENYAICH ZAKARIAE", role: "Professeur en Neurochirurgie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BERRAJAA MEHDI", role: "Professeur en Cardiologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BOUABDALLAOUI AMINE", role: "Professeur en Anesthésie-Réanimation au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BOUCHOUAL MOHAMMED", role: "Professeur en Néphrologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BOUISSAR WASSILA", role: "Professeur en Médecine Interne au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. BOUSLOUS NABIL", role: "Professeur en Ophtalmologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. CHACHI EL MOSTAFA", role: "Professeur en Chimie -Biochimie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. CHAIT YASSINE", role: "Professeur en Gastro-Entérologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. CHAKIRI RADIA", role: "Professeur en Dermatologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. CHAKRI IMAD", role: "Professeur en Informatique Médicale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. CHERRABI HIND", role: "Professeur en Chirurgie Pédiatrique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. DAMOUN IKRAM", role: "Professeur en Endocrinologie et maladies métaboliques au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. DAOUDI ABDELLATIF", role: "Professeur en Pédiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. DAOUDI NAIMA", role: "Professeur en Microbiologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. DERGAMOUN HAMZA", role: "Professeur en Urologie (Anatomie) au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. DOUFIK JALAL", role: "Professeur en Psychiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EL FAKIRI MOHAMED MEHDI", role: "Professeur en Anatomie (ORL) au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EL FANE MOUNA", role: "Professeur en Maladies infectieuses au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EL HYAOUI HICHAM", role: "Professeur en Traumato-Orthopédie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EL MAATAOUI AISSAM", role: "Professeur en Biochimie médicale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EL MEKKAOUI ADEL", role: "Professeur en Anésthésie et réanimation au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EL MINAOUI MOHAMED", role: "Professeur en Cardiologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EL MRIMAR NADIA", role: "Professeur en Hématologie Biologique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ELFAROUQI ABDALLAH", role: "Professeur en Gynécologie Obstétrique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ELMEHDI MAIDI", role: "Professeur en Chirurgie Thoracique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ERRAOUI MARIAM", role: "Professeur en Rhumatologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. EZZARIGA NIHAL", role: "Professeur en Microbiologie -Virologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. FARES SALMA", role: "Professeur en Hématologie Clinique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. HADDARI FATIMA-ZAHRA", role: "Professeur en Anesthésie-Réanimation au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. HAMRI SALIHA", role: "Professeur en Pédopsychiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. JABRANE MAROUANE", role: "Professeur en Néphrologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. KASSIMI HASSAN", role: "Professeur en Médecine physique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. KHABBAL YOUSSEF", role: "Professeur en Pharmacologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. KHARROUBI ABDELKARIM", role: "Professeur en Chirurgie Vasculaire Périphérique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. KHAYER SARA", role: "Professeur en Maladies infectieuses au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. KHAYI FATIMA-EZZAHRA", role: "Professeur en Pédiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. LAADAMI SARA", role: "Professeur en Neurologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. LAHLOU LAILA", role: "Professeur en Médecine Communautaire préventive, santé publique et hygiène au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. LEFQIH IMANE", role: "Professeur en Anatomie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. LEMKHENTE ZOHRA", role: "Professeur en Parasitologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. LMEJJATI MOHAMED", role: "Professeur en Neurochirurgie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. MADANI AYOUB", role: "Professeur en Chirurgie Générale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. MIRY ACHREF", role: "Professeur en Anatomie Pathologique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. MOUBACHIR HOUDA", role: "Professeur en Pneumologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. MOUSTAINE MOULAY OMAR", role: "Professeur en Ophtalmologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. NAINIA KHALILA", role: "Professeur en Pédiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. NAJI YAHYA", role: "Professeur en Neurologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. NASSIK HICHAM", role: "Professeur en Anesthésie réanimation au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. OQBANI KENZA", role: "Professeur en Anatomie pathologique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. OUAZNI MOHAMMED", role: "Professeur en Chirurgie viscérale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. OUKHOUYA MOHAMED AMINE", role: "Professeur en Chirurgie Pédiatrique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. RAFIQI KAMAL", role: "Professeur en Traumato-orthopédie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. RAIS GHIZLANE", role: "Professeur en Oncologie Médicale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. RAMMOUZ ISMAIL", role: "Professeur en Psychiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. RHARS AMAL", role: "Professeur en Parasitologie – Mycologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. RIDA FATIMA EZZAHRA", role: "Professeur en Hématologie Clinique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. SAFINI FATIMA", role: "Professeur en Radiothérapie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. SAOULI AMINE", role: "Professeur en Urologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. SAYAD ZAHRA", role: "Professeur en Stomatologie et chirurgie maxillo-faciale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. SEFRIOUI TAHA ISMAIL", role: "Professeur en Oto-Rhino-Laryngologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. SERBATI NADIA", role: "Professeur en Génétique au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. SERHANE HIND", role: "Professeur en Pneumologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. SOUFI MEHDI", role: "Professeur en Chirurgie viscérale au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. TAOUIHAR SALMA", role: "Professeur en Anesthésie-Réanimation au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. TIZKI SAMIRA", role: "Professeur en Pédiatrie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. WAKRIM SOUKAINA", role: "Professeur en Radiologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. WAZAREN HICHAM", role: "Professeur en Chirurgie Cardiovasculaire au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "Pr. ZIOUZIOU IMAD", role: "Professeur en Urologie au Centre Hospitalo-Universitaire de Souss-Massa" },
        { name: "M. EL YOUBI ZOUHAIR", role: "Chef du Service de la Pharmacie centrale au centre hospitalo-universitaire Souss-Massa" },
        { name: "M. BOUHAL Mohamed Choukri", role: "Pharmacien au Centre Hospitalo-Universitaire Souss Massa" },
        { name: "Mme. ABATOUR LATIFA", role: "Pharmacienne au Centre Hospitalo-Universitaire Souss Massa" },
        { name: "Mme. EL MKIESS ZAINEB", role: "Pharmacienne au Centre Hospitalo-Universitaire Souss Massa" },
        { name: "M. NAFIAA KAMAL", role: "Pharmacien au Centre Hospitalo-Universitaire Souss Massa" },
        { name: "Mme. BEN GHAZOUANI AHLAME", role: "Infirmière chef de stérilisation au Centre Hospitalo-Universitaire Souss Massa" },
        { name: "Mme. HARIRI MAJDA", role: "Pharmacienne au Centre d'Oncologie d'Agadir relevant du Centre Hospitalo-Universitaire Souss-Massa" },
        { name: "Mme. EZ-ZAYDY IKRAM", role: "Chef du Service des systèmes d'informations et informatiques au Centre Hospitalo-Universitaire Souss-Massa" },
        { name: "M. MOUSSAFIR MUSTAFA", role: "Ingénieur 1er grade, au Service des systèmes d'informations et informatiques au Centre Hospitalo-Universitaire Souss-Massa" },
        { name: "M. IGUIOUI ISSAM", role: "Technicien 4ème grade au Service des systèmes d'informations et informatiques au CHU Souss-Massa" },
        { name: "M. TAKKI Mohamed", role: "Technicien 4ème grade au Service des systèmes d'informations et informatiques au CHU Souss-Massa" },
        { name: "Mme. LAFLAFLI SABAH", role: "Administrateur 2ème Grade au service d'audit interne et contrôle de gestion au CHU Souss-Massa" },
        { name: "Mme. EL WAFKI DOUNIA", role: "Administrateur 2ème Grade au service d'audit interne et contrôle de gestion au CHU Souss-Massa" },
        { name: "Mme. AMAZIANE FATIMA ZAHRAE", role: "Ingénieur 1er grade au Service du patrimoine, logistique et approvisionnement au CHU Souss-Massa" },
        { name: "M. ELBAAMRANI SAID", role: "Chef du Service du patrimoine, logistique et approvisionnement au CHU Souss-Massa" },
        { name: "M. ABDOULLAH BELLA", role: "Chef de la Division du Patrimoine et d'ingénierie au CHU Souss-Massa" },
        { name: "Mme. AICHA ALHYAN", role: "Technicienne 4ème grade au Service du patrimoine, logistique et approvisionnement au CHU Souss-Massa" },
        { name: "Mme. HADANI FERDAOUS", role: "Administrateur 2ème grade au service des équipements biomédicaux et de la maintenance" },
        { name: "Mme. AOULADI MINA", role: "Chef de Division des ressources humaines et du développement professionnel continu au CHU Souss-Massa" },
        { name: "M. ZOUHAIR MEKLAOUI", role: "Chef de service des ressources humaines au CHU Souss-Massa" },
        { name: "M. MOUSSA RABHI", role: "Technicien 3ème grade au service de formation continue et gestion compétence au CHU Souss-Massa" },
        { name: "Mme. HASNAE HICHMINE", role: "Technicienne 3ème grade au service de gestion de la paie et de rémunération Au Centre Hospitalo-Universitaire Souss-Massa" },
        { name: "Mme. IBN ZAID Fatima Ez-Zahra", role: "Responsable du Service de la Comptabilité Au Centre Hospitalo-Universitaire Souss-Massa" }
    ];

    // Trier les destinataires par ordre alphabétique
    preloadedRecipients.sort((a, b) => a.name.localeCompare(b.name));
    
    // Données de l'application
    let recipients = [];
    let recipientsAlloti = [];
    
    // Variables pour l'édition et la pagination
    let editingIndex = -1;
    let editingIndexAlloti = -1;
    let currentPage = 0;
    let viewAllMode = false;
    let currentMode = 'lot-unique'; // 'lot-unique' ou 'alloti'
    
    // Éléments DOM
    // Mode Lot Unique
    const dateTimeInput = document.getElementById('dateTime');
    const locationInput = document.getElementById('location');
    const examenTypeInput = document.getElementById('examenType');
    const referenceInput = document.getElementById('reference');
    const objectInput = document.getElementById('object');
    const offerTypeInput = document.getElementById('offerType');
    const recipientNameInput = document.getElementById('recipientName');
    const recipientRoleInput = document.getElementById('recipientRole');
    const searchRecipientInput = document.getElementById('searchRecipient');
    const selectRecipient = document.getElementById('selectRecipient');
    const suggestionsLotUnique = document.getElementById('suggestionsLotUnique');
    const addRecipientBtn = document.getElementById('addRecipient');
    const recipientsList = document.getElementById('recipientsList');
    const dayInput = document.getElementById('day');
    const monthInput = document.getElementById('month');
    const yearInput = document.getElementById('year');
    const hourInput = document.getElementById('hour');
    const minuteInput = document.getElementById('minute');
    
    // Mode Alloti
    const dateTimeInputAlloti = document.getElementById('dateTimeAlloti');
    const locationInputAlloti = document.getElementById('locationAlloti');
    const examenTypeInputAlloti = document.getElementById('examenTypeAlloti');
    const referenceInputAlloti = document.getElementById('referenceAlloti');
    const objectInputAlloti = document.getElementById('objectAlloti');
    const offerTypeInputAlloti = document.getElementById('offerTypeAlloti');
    const recipientNameInputAlloti = document.getElementById('recipientNameAlloti');
    const recipientRoleInputAlloti = document.getElementById('recipientRoleAlloti');
    const searchRecipientInputAlloti = document.getElementById('searchRecipientAlloti');
    const selectRecipientAlloti = document.getElementById('selectRecipientAlloti');
    const suggestionsAlloti = document.getElementById('suggestionsAlloti');
    const addRecipientBtnAlloti = document.getElementById('addRecipientAlloti');
    const recipientsListAlloti = document.getElementById('recipientsListAlloti');
    const lotsInput = document.getElementById('lots');
    const lotsError = document.getElementById('lotsError');
    const dayInputAlloti = document.getElementById('dayAlloti');
    const monthInputAlloti = document.getElementById('monthAlloti');
    const yearInputAlloti = document.getElementById('yearAlloti');
    const hourInputAlloti = document.getElementById('hourAlloti');
    const minuteInputAlloti = document.getElementById('minuteAlloti');
    
    // Éléments communs
    const btnLotUnique = document.getElementById('btnLotUnique');
    const btnAlloti = document.getElementById('btnAlloti');
    const sectionLotUnique = document.getElementById('sectionLotUnique');
    const sectionAlloti = document.getElementById('sectionAlloti');
    const previewRecipientSelect = document.getElementById('previewRecipient');
    const invitationDocument = document.getElementById('invitationDocument');
    const generatePdfBtn = document.getElementById('generatePdf');
    const generateAllPdfBtn = document.getElementById('generateAllPdf');
    const generateAllPdfBtnAlloti = document.getElementById('generateAllPdfAlloti');
    const viewAllBtn = document.getElementById('viewAll');
    const viewAllBtnAlloti = document.getElementById('viewAllAlloti');
    const paginationDiv = document.getElementById('pagination');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoSpan = document.getElementById('pageInfo');
    const globalError = document.getElementById('globalError');
    
    // Fonction d'initialisation des composants
    function initializeInvitationComponents() {
        updateRecipientsList();
        updateRecipientsListAlloti();
        updatePreviewRecipientSelect();
        initializeSelectRecipients();
        
        // Ajouter l'option "Voir tout" au sélecteur en premier
        const viewAllOption = document.createElement('option');
        viewAllOption.value = "all";
        viewAllOption.textContent = "Voir tout";
        previewRecipientSelect.appendChild(viewAllOption);
        
        // Initialiser la recherche de destinataires
        initializeSearch();
        
        // Afficher un message si aucun destinataire
        if (recipients.length === 0 && recipientsAlloti.length === 0) {
            invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Aucun destinataire sélectionné. Veuillez ajouter des destinataires.</p>';
        }
    }

    // Initialiser les sélecteurs de destinataires
    function initializeSelectRecipients() {
        // Mode Lot Unique
        selectRecipient.innerHTML = '<option value="">Choisir un destinataire</option>';
        preloadedRecipients.forEach(recipient => {
            const option = document.createElement('option');
            option.value = recipient.name;
            option.textContent = recipient.name;
            selectRecipient.appendChild(option);
        });
        
        // Mode Alloti
        selectRecipientAlloti.innerHTML = '<option value="">Choisir un destinataire</option>';
        preloadedRecipients.forEach(recipient => {
            const option = document.createElement('option');
            option.value = recipient.name;
            option.textContent = recipient.name;
            selectRecipientAlloti.appendChild(option);
        });
    }
    
    // Changer de mode
    btnLotUnique.addEventListener('click', function() {
        currentMode = 'lot-unique';
        btnLotUnique.classList.add('active');
        btnAlloti.classList.remove('active');
        sectionLotUnique.classList.remove('hidden');
        sectionAlloti.classList.add('hidden');
        updatePreviewRecipientSelect();
        initializeInvitationComponents(); // Réinitialiser les composants
        if (recipients.length > 0) {
            renderInvitation(0);
            previewRecipientSelect.value = 0;
        } else {
            invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Aucun destinataire sélectionné. Veuillez ajouter des destinataires.</p>';
        }
    });
    
    btnAlloti.addEventListener('click', function() {
        currentMode = 'alloti';
        btnAlloti.classList.add('active');
        btnLotUnique.classList.remove('active');
        sectionAlloti.classList.remove('hidden');
        sectionLotUnique.classList.add('hidden');
        updatePreviewRecipientSelect();
        initializeInvitationComponents(); // Réinitialiser les composants
        if (recipientsAlloti.length > 0) {
            renderInvitation(0);
            previewRecipientSelect.value = 0;
        } else {
            invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Aucun destinataire sélectionné. Veuillez ajouter des destinataires.</p>';
        }
    });
    
    // Initialiser la recherche de destinataires avec suggestions
    function initializeSearch() {
        // Mode Lot Unique - Recherche
        searchRecipientInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            if (searchTerm.length < 2) {
                suggestionsLotUnique.style.display = 'none';
                return;
            }
            
            const filtered = preloadedRecipients.filter(recipient => 
                recipient.name.toLowerCase().includes(searchTerm) || 
                recipient.role.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length > 0) {
                suggestionsLotUnique.innerHTML = '';
                filtered.forEach(recipient => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.innerHTML = `
                        <div><strong>${recipient.name}</strong></div>
                        <div style="font-size: 0.8em; color: #666;">${recipient.role}</div>
                    `;
                    suggestionItem.addEventListener('click', function() {
                        addRecipientFromList(recipient, 'lot-unique');
                        suggestionsLotUnique.style.display = 'none';
                        searchRecipientInput.value = '';
                    });
                    suggestionsLotUnique.appendChild(suggestionItem);
                });
                suggestionsLotUnique.style.display = 'block';
            } else {
                suggestionsLotUnique.style.display = 'none';
            }
        });
        
        // Mode Lot Unique - Sélection
        selectRecipient.addEventListener('change', function() {
            if (this.value) {
                const recipient = preloadedRecipients.find(r => r.name === this.value);
                if (recipient) {
                    addRecipientFromList(recipient, 'lot-unique');
                    this.value = '';
                }
            }
        });
        
        // Mode Alloti - Recherche
        searchRecipientInputAlloti.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            if (searchTerm.length < 2) {
                suggestionsAlloti.style.display = 'none';
                return;
            }
            
            const filtered = preloadedRecipients.filter(recipient => 
                recipient.name.toLowerCase().includes(searchTerm) || 
                recipient.role.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length > 0) {
                suggestionsAlloti.innerHTML = '';
                filtered.forEach(recipient => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.innerHTML = `
                        <div><strong>${recipient.name}</strong></div>
                        <div style="font-size: 0.8em; color: #666;">${recipient.role}</div>
                    `;
                    suggestionItem.addEventListener('click', function() {
                        addRecipientFromList(recipient, 'alloti');
                        suggestionsAlloti.style.display = 'none';
                        searchRecipientInputAlloti.value = '';
                    });
                    suggestionsAlloti.appendChild(suggestionItem);
                });
                suggestionsAlloti.style.display = 'block';
            } else {
                suggestionsAlloti.style.display = 'none';
            }
        });
        
        // Mode Alloti - Sélection
        selectRecipientAlloti.addEventListener('change', function() {
            if (this.value) {
                const recipient = preloadedRecipients.find(r => r.name === this.value);
                if (recipient) {
                    addRecipientFromList(recipient, 'alloti');
                    this.value = '';
                }
            }
        });
        
        // Cacher les suggestions en cliquant ailleurs
        document.addEventListener('click', function(e) {
            if (!searchRecipientInput.contains(e.target) && !suggestionsLotUnique.contains(e.target)) {
                suggestionsLotUnique.style.display = 'none';
            }
            if (!searchRecipientInputAlloti.contains(e.target) && !suggestionsAlloti.contains(e.target)) {
                suggestionsAlloti.style.display = 'none';
            }
        });
    }
    
    // Ajouter un destinataire à partir de la liste préchargée
    function addRecipientFromList(recipient, mode) {
        if (mode === 'lot-unique') {
            // Vérifier si le destinataire n'est pas déjà présent
            const existingIndex = recipients.findIndex(r => r.name === recipient.name);
            if (existingIndex === -1) {
                recipients.push(recipient);
                updateRecipientsList();
                updatePreviewRecipientSelect();
                
                // Afficher le dernier destinataire dans l'aperçu
                if (recipients.length > 0 && !viewAllMode) {
                    const lastIndex = recipients.length - 1;
                    renderInvitation(lastIndex);
                    previewRecipientSelect.value = lastIndex;
                }
            } else {
                alert('Ce destinataire est déjà dans la liste');
            }
        } else {
            // Mode Alloti
            // Vérifier si le destinataire n'est pas déjà présent
            const existingIndex = recipientsAlloti.findIndex(r => r.name === recipient.name);
            if (existingIndex === -1) {
                recipientsAlloti.push(recipient);
                updateRecipientsListAlloti();
                updatePreviewRecipientSelect();
                
                // Afficher le dernier destinataire dans l'aperçu
                if (recipientsAlloti.length > 0 && !viewAllMode) {
                    const lastIndex = recipientsAlloti.length - 1;
                    renderInvitation(lastIndex);
                    previewRecipientSelect.value = lastIndex;
                }
            } else {
                alert('Ce destinataire est déjà dans la liste');
            }
        }
    }
    
    // Ajouter un destinataire personnalisé (Mode Lot Unique)
    addRecipientBtn.addEventListener('click', function() {
        const name = recipientNameInput.value.trim();
        const role = recipientRoleInput.value.trim();
        
        if (name && role) {
            if (editingIndex >= 0) {
                // Modification d'un destinataire existant
                recipients[editingIndex] = { name, role };
                editingIndex = -1;
                addRecipientBtn.textContent = 'Ajouter Destinataire';
            } else {
                // Ajout d'un nouveau destinataire
                recipients.push({ name, role });
            }
            
            updateRecipientsList();
            updatePreviewRecipientSelect();
            recipientNameInput.value = '';
            recipientRoleInput.value = '';
            searchRecipientInput.value = '';
            
            // Afficher le dernier destinataire dans l'aperçu
            if (recipients.length > 0 && !viewAllMode) {
                const lastIndex = recipients.length - 1;
                renderInvitation(lastIndex);
                previewRecipientSelect.value = lastIndex;
            }
        } else {
            alert('Veuillez remplir le nom et la fonction du destinataire');
        }
    });
    
    // Ajouter un destinataire personnalisé (Mode Alloti)
    addRecipientBtnAlloti.addEventListener('click', function() {
        const name = recipientNameInputAlloti.value.trim();
        const role = recipientRoleInputAlloti.value.trim();
        
        if (name && role) {
            if (editingIndexAlloti >= 0) {
                // Modification d'un destinataire existant
                recipientsAlloti[editingIndexAlloti] = { name, role };
                editingIndexAlloti = -1;
                addRecipientBtnAlloti.textContent = 'Ajouter Destinataire';
            } else {
                // Ajout d'un nouveau destinataire
                recipientsAlloti.push({ name, role });
            }
            
            updateRecipientsListAlloti();
            updatePreviewRecipientSelect();
            recipientNameInputAlloti.value = '';
            recipientRoleInputAlloti.value = '';
            searchRecipientInputAlloti.value = '';
            
            // Afficher le dernier destinataire dans l'aperçu
            if (recipientsAlloti.length > 0 && !viewAllMode) {
                const lastIndex = recipientsAlloti.length - 1;
                renderInvitation(lastIndex);
                previewRecipientSelect.value = lastIndex;
            }
        } else {
            alert('Veuillez remplir le nom et la fonction du destinataire');
        }
    });
    
    // Mettre à jour la liste des destinataires (Mode Lot Unique)
    function updateRecipientsList() {
        recipientsList.innerHTML = '';
        
        if (recipients.length === 0) {
            recipientsList.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Aucun destinataire ajouté</p>';
            return;
        }
        
        recipients.forEach((recipient, index) => {
            const recipientItem = document.createElement('div');
            recipientItem.className = 'recipient-item';
            
            const recipientInfo = document.createElement('div');
            recipientInfo.className = 'recipient-info-small';
            recipientInfo.innerHTML = `
                <div class="recipient-name-small">${recipient.name}</div>
                <div class="recipient-role-small">${recipient.role}</div>
            `;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'recipient-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-warning btn-small';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Modifier';
            editBtn.addEventListener('click', function() {
                recipientNameInput.value = recipient.name;
                recipientRoleInput.value = recipient.role;
                editingIndex = index;
                addRecipientBtn.textContent = 'Modifier Destinataire';
                // Positionner le curseur sur le champ du nom
                recipientNameInput.focus();
                recipientNameInput.select();
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-small';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = 'Supprimer';
            deleteBtn.addEventListener('click', function() {
                recipients.splice(index, 1);
                updateRecipientsList();
                updatePreviewRecipientSelect();
                
                // Si on supprime le destinataire en cours d'édition
                if (editingIndex === index) {
                    editingIndex = -1;
                    addRecipientBtn.textContent = 'Ajouter Destinataire';
                    recipientNameInput.value = '';
                    recipientRoleInput.value = '';
                }
                
                // Afficher le premier destinataire si disponible
                if (recipients.length > 0 && !viewAllMode) {
                    renderInvitation(0);
                    previewRecipientSelect.value = 0;
                } else {
                    invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Aucun destinataire sélectionné. Veuillez ajouter des destinataires.</p>';
                }
            });
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            recipientItem.appendChild(recipientInfo);
            recipientItem.appendChild(actionsDiv);
            recipientsList.appendChild(recipientItem);
        });
    }
    
    // Mettre à jour la liste des destinataires (Mode Alloti)
    function updateRecipientsListAlloti() {
        recipientsListAlloti.innerHTML = '';
        
        if (recipientsAlloti.length === 0) {
            recipientsListAlloti.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Aucun destinataire ajouté</p>';
            return;
        }
        
        recipientsAlloti.forEach((recipient, index) => {
            const recipientItem = document.createElement('div');
            recipientItem.className = 'recipient-item';
            
            const recipientInfo = document.createElement('div');
            recipientInfo.className = 'recipient-info-small';
            recipientInfo.innerHTML = `
                <div class="recipient-name-small">${recipient.name}</div>
                <div class="recipient-role-small">${recipient.role}</div>
            `;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'recipient-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-warning btn-small';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Modifier';
            editBtn.addEventListener('click', function() {
                recipientNameInputAlloti.value = recipient.name;
                recipientRoleInputAlloti.value = recipient.role;
                editingIndexAlloti = index;
                addRecipientBtnAlloti.textContent = 'Modifier Destinataire';
                // Positionner le curseur sur le champ du nom
                recipientNameInputAlloti.focus();
                recipientNameInputAlloti.select();
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-small';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = 'Supprimer';
            deleteBtn.addEventListener('click', function() {
                recipientsAlloti.splice(index, 1);
                updateRecipientsListAlloti();
                updatePreviewRecipientSelect();
                
                // Si on supprime le destinataire en cours d'édition
                if (editingIndexAlloti === index) {
                    editingIndexAlloti = -1;
                    addRecipientBtnAlloti.textContent = 'Ajouter Destinataire';
                    recipientNameInputAlloti.value = '';
                    recipientRoleInputAlloti.value = '';
                }
                
                // Afficher le premier destinataire si disponible
                if (recipientsAlloti.length > 0 && !viewAllMode) {
                    renderInvitation(0);
                    previewRecipientSelect.value = 0;
                } else {
                    invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Aucun destinataire sélectionné. Veuillez ajouter des destinataires.</p>';
                }
            });
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            recipientItem.appendChild(recipientInfo);
            recipientItem.appendChild(actionsDiv);
            recipientsListAlloti.appendChild(recipientItem);
        });
    }
    
    // Mettre à jour le sélecteur d'aperçu
    function updatePreviewRecipientSelect() {
        // Sauvegarder la valeur actuelle
        const currentValue = previewRecipientSelect.value;
        
        // Supprimer toutes les options sauf "Voir tout"
        while (previewRecipientSelect.children.length > 1) {
            previewRecipientSelect.removeChild(previewRecipientSelect.lastChild);
        }
        
        const currentRecipients = currentMode === 'lot-unique' ? recipients : recipientsAlloti;
        
        currentRecipients.forEach((recipient, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = recipient.name;
            previewRecipientSelect.appendChild(option);
        });
        
        // Restaurer la valeur si possible
        if (currentValue !== "all" && currentRecipients[currentValue]) {
            previewRecipientSelect.value = currentValue;
        } else if (currentRecipients.length > 0) {
            previewRecipientSelect.value = 0;
        } else {
            previewRecipientSelect.value = "all";
        }
    }
    
    // Changer l'affichage lorsqu'un destinataire est sélectionné
    previewRecipientSelect.addEventListener('change', function() {
        if (this.value === "all") {
            viewAllMode = true;
            paginationDiv.style.display = 'flex';
            currentPage = 0;
            updatePagination();
            renderAllInvitations();
        } else {
            viewAllMode = false;
            paginationDiv.style.display = 'none';
            const index = parseInt(this.value);
            renderInvitation(index);
        }
    });
    
    // Navigation dans le mode "Voir tout"
    prevPageBtn.addEventListener('click', function() {
        if (currentPage > 0) {
            currentPage--;
            updatePagination();
            renderAllInvitations();
        }
    });
    
    nextPageBtn.addEventListener('click', function() {
        const currentRecipients = currentMode === 'lot-unique' ? recipients : recipientsAlloti;
        if (currentPage < Math.ceil(currentRecipients.length / 1) - 1) {
            currentPage++;
            updatePagination();
            renderAllInvitations();
        }
    });
    
    // Mettre à jour la pagination
    function updatePagination() {
        const currentRecipients = currentMode === 'lot-unique' ? recipients : recipientsAlloti;
        const totalPages = Math.ceil(currentRecipients.length / 1);
        pageInfoSpan.textContent = `Page ${currentPage + 1} sur ${totalPages}`;
        
        prevPageBtn.disabled = currentPage === 0;
        nextPageBtn.disabled = currentPage === totalPages - 1;
    }
    
    // Visualiser tout (Mode Lot Unique)
    viewAllBtn.addEventListener('click', function() {
        if (recipients.length === 0) {
            alert("Aucun destinataire à visualiser");
            return;
        }
        
        previewRecipientSelect.value = "all";
        viewAllMode = true;
        paginationDiv.style.display = 'flex';
        currentPage = 0;
        updatePagination();
        renderAllInvitations();
    });
    
    // Visualiser tout (Mode Alloti)
    viewAllBtnAlloti.addEventListener('click', function() {
        if (recipientsAlloti.length === 0) {
            alert("Aucun destinataire à visualiser");
            return;
        }
        
        previewRecipientSelect.value = "all";
        viewAllMode = true;
        paginationDiv.style.display = 'flex';
        currentPage = 0;
        updatePagination();
        renderAllInvitations();
    });
    
    // Formater les lots
    function formatLots(lotsString) {
        // Nettoyer et trier les lots
        const lotsArray = lotsString.split(',')
            .map(lot => lot.trim())
            .filter(lot => lot !== '')
            .sort((a, b) => parseInt(a) - parseInt(b));
        
        // Vérifier les doublons
        const uniqueLots = [...new Set(lotsArray)];
        if (uniqueLots.length !== lotsArray.length) {
            return { formatted: null, error: "Des lots en double ont été détectés. Veuillez corriger." };
        }
        
        // Formater l'affichage
        if (uniqueLots.length === 0) {
            return { formatted: "", error: "Veuillez saisir au moins un lot" };
        } else if (uniqueLots.length === 1) {
            return { formatted: uniqueLots[0], error: null };
        } else {
            const lastLot = uniqueLots.pop();
            return { formatted: `${uniqueLots.join(', ')} et ${lastLot}`, error: null };
        }
    }
    
    // Formater la date et l'heure
    function formatDateTime(day, month, year, hour, minute) {
        // Vérifier si l'heure est renseignée
        const hasTime = hour && minute && hour !== '' && minute !== '';
        
        if (hasTime) {
            return `${day}/${month}/${year} à ${hour}h${minute}`;
        } else {
            return `${day}/${month}/${year}`;
        }
    }
    
    // Rendu de l'invitation pour un destinataire
    function renderInvitation(recipientIndex) {
        const currentRecipients = currentMode === 'lot-unique' ? recipients : recipientsAlloti;
        
        if (recipientIndex < 0 || recipientIndex >= currentRecipients.length) {
            invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Aucun destinataire sélectionné</p>';
            return;
        }
        
        const recipient = currentRecipients[recipientIndex];
        
        // Construire la référence complète
        const reference = `Appel d'Offres Ouvert ${offerTypeInput.value} N° ${referenceInput.value}`;
        const referenceAlloti = `Appel d'Offres Ouvert ${offerTypeInputAlloti.value} N° ${referenceInputAlloti.value}`;
        
        // Formater la date et l'heure
        const dateTime = formatDateTime(dayInput.value, monthInput.value, yearInput.value, hourInput.value, minuteInput.value);
        const dateTimeAlloti = formatDateTime(dayInputAlloti.value, monthInputAlloti.value, yearInputAlloti.value, hourInputAlloti.value, minuteInputAlloti.value);
        
        if (currentMode === 'lot-unique') {
            // Mode Lot Unique
            invitationDocument.innerHTML = `
                <div class="document-header">
                    <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                </div>
                <br><br>
               <p style="text-align:center; font-weight:bold; font-size:20px;">À</p>
                <div class="document-content">
                    <div class="recipient-info">
                        <div class="recipient-name">${recipient.name}</div>
                        <div class="recipient-role">${recipient.role}</div>
                    </div>
                    
                    <div class="section-title">INVITATION</div>
                    
                    <div class="section-content">
                        <p>Je vous demanderais de bien vouloir assister à la séance la conformité qui aura lieu le <span class="bold-text">${dateTime}</span> au ${locationInput.value}.</p>
                    </div>
                    
                    <div class="section-title">ORDRE DU JOUR</div>
                    
                    <div class="section-content">
                        <p>Examen ${examenTypeInput.value} concernant l'<span class="bold-text">${reference}</span> relatif à : « <span class="bold-text">${objectInput.value}</span> ».</p>
                    </div>
                </div>
                
                <div class="document-footer">
                    <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                </div>
            `;
        } else {
            // Mode Alloti
            // Vérifier et formater les lots
            const lotsResult = formatLots(lotsInput.value);
            
            if (lotsResult.error) {
                lotsError.textContent = lotsResult.error;
                lotsError.style.display = 'block';
                globalError.textContent = lotsResult.error;
                globalError.style.display = 'block';
                invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Erreur dans la saisie des lots. Veuillez corriger avant de générer le document.</p>';
                return;
            } else {
                lotsError.style.display = 'none';
                globalError.style.display = 'none';
            }
            
            invitationDocument.innerHTML = `
                <div class="document-header">
                    <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                </div>
                <br><br>
               <p style="text-align:center; font-weight:bold; font-size:20px;">À</p>
                <div class="document-content">
                    <div class="recipient-info">
                        <div class="recipient-name">${recipient.name}</div>
                        <div class="recipient-role">${recipient.role}</div>
                    </div>
                    
                    <div class="section-title">INVITATION</div>
                    
                    <div class="section-content">
                        <p>Je vous demanderais de bien vouloir assister à la séance d'examen ${examenTypeInputAlloti.value} des lots N° <span class="bold-text">${lotsResult.formatted}</span> qui aura lieu le <span class="bold-text">${dateTimeAlloti}</span> au ${locationInputAlloti.value}.</p>
                    </div>
                    
                    <div class="section-title">ORDRE DU JOUR</div>
                    
                    <div class="section-content">
                        <p>Examen ${examenTypeInputAlloti.value} concernant l'<span class="bold-text">${referenceAlloti}</span> relatif à : « <span class="bold-text">${objectInputAlloti.value}</span> ».</p>
                    </div>
                </div>
                
                <div class="document-footer">
                    <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                </div>
            `;
        }
    }
    
    // Rendu de toutes les invitations (mode pagination)
    function renderAllInvitations() {
        const currentRecipients = currentMode === 'lot-unique' ? recipients : recipientsAlloti;
        
        if (currentRecipients.length === 0) {
            invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Aucun destinataire à afficher</p>';
            return;
        }
        
        // Pour le mode Alloti, vérifier d'abord les lots
        if (currentMode === 'alloti') {
            const lotsResult = formatLots(lotsInput.value);
            if (lotsResult.error) {
                lotsError.textContent = lotsResult.error;
                lotsError.style.display = 'block';
                globalError.textContent = lotsResult.error;
                globalError.style.display = 'block';
                invitationDocument.innerHTML = '<p style="text-align: center; margin-top: 50px;">Erreur dans la saisie des lots. Veuillez corriger avant de générer le document.</p>';
                return;
            } else {
                lotsError.style.display = 'none';
                globalError.style.display = 'none';
            }
        }
        
        let content = '';
        const startIndex = currentPage * 1;
        const endIndex = Math.min(startIndex + 1, currentRecipients.length);
        
        // Construire les références
        const reference = `Appel d'Offres Ouvert ${offerTypeInput.value} N° ${referenceInput.value}`;
        const referenceAlloti = `Appel d'Offres Ouvert ${offerTypeInputAlloti.value} N° ${referenceInputAlloti.value}`;
        
        // Formater la date et l'heure
        const dateTime = formatDateTime(dayInput.value, monthInput.value, yearInput.value, hourInput.value, minuteInput.value);
        const dateTimeAlloti = formatDateTime(dayInputAlloti.value, monthInputAlloti.value, yearInputAlloti.value, hourInputAlloti.value, minuteInputAlloti.value);
        
        for (let i = startIndex; i < endIndex; i++) {
            const recipient = currentRecipients[i];
            
            if (currentMode === 'lot-unique') {
                // Mode Lot Unique
                content += `
                    <div class="document-header">
                        <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                    </div>
                    
                    <div class="document-content">
                        <div class="recipient-info">
                            <div class="recipient-name">${recipient.name}</div>
                            <div class="recipient-role">${recipient.role}</div>
                        </div>
                        
                        <div class="section-title">INVITATION</div>
                        
                        <div class="section-content">
                            <p>Je vous demanderais de bien vouloir assister à la séance la conformité qui aura lieu le <span class="bold-text">${dateTime}</span> au ${locationInput.value}.</p>
                        </div>
                        
                        <div class="section-title">ORDRE DU JOUR</div>
                        
                        <div class="section-content">
                            <p>Examen ${examenTypeInput.value} concernant l'<span class="bold-text">${reference}</span> relatif à : « <span class="bold-text">${objectInput.value}</span> ».</p>
                        </div>
                    </div>
                    
                    <div class="document-footer">
                        <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                    </div>
                `;
            } else {
                // Mode Alloti
                const lotsResult = formatLots(lotsInput.value);
                
                content += `
                    <div class="document-header">
                        <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                    </div>
                    
                    <div class="document-content">
                        <div class="recipient-info">
                            <div class="recipient-name">${recipient.name}</div>
                            <div class="recipient-role">${recipient.role}</div>
                        </div>
                        
                        <div class="section-title">INVITATION</div>
                        
                        <div class="section-content">
                            <p>Je vous demanderais de bien vouloir assister à la séance d'examen ${examenTypeInputAlloti.value} des lots N° <span class="bold-text">${lotsResult.formatted}</span> qui aura lieu le <span class="bold-text">${dateTimeAlloti}</span> au ${locationInputAlloti.value}.</p>
                        </div>
                        
                        <div class="section-title">ORDRE DU JOUR</div>
                        
                        <div class="section-content">
                            <p>Examen ${examenTypeInputAlloti.value} concernant l'<span class="bold-text">${referenceAlloti}</span> relatif à : « <span class="bold-text">${objectInputAlloti.value}</span> ».</p>
                        </div>
                    </div>
                    
                    <div class="document-footer">
                        <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                    </div>
                `;
            }
        }
        
        invitationDocument.innerHTML = content;
    }
    
    // Générer un PDF pour le destinataire actuel
    generatePdfBtn.addEventListener('click', function() {
        if (viewAllMode) {
            // Générer tous les PDF en mode "Voir tout"
            generateAllPdfs();
        } else {
            const recipientIndex = parseInt(previewRecipientSelect.value);
            
            // Pour le mode Alloti, vérifier d'abord les lots
            if (currentMode === 'alloti') {
                const lotsResult = formatLots(lotsInput.value);
                if (lotsResult.error) {
                    lotsError.textContent = lotsResult.error;
                    lotsError.style.display = 'block';
                    globalError.textContent = lotsResult.error;
                    globalError.style.display = 'block';
                    alert("Impossible de générer le PDF : " + lotsResult.error);
                    return;
                }
            }
            
            generatePdf(recipientIndex);
        }
    });
    
    // Générer tous les PDF (Mode Lot Unique)
    generateAllPdfBtn.addEventListener('click', function() {
        generateAllPdfs();
    });
    
    // Générer tous les PDF (Mode Alloti)
    generateAllPdfBtnAlloti.addEventListener('click', function() {
        // Vérifier d'abord les lots
        const lotsResult = formatLots(lotsInput.value);
        if (lotsResult.error) {
            lotsError.textContent = lotsResult.error;
            lotsError.style.display = 'block';
            globalError.textContent = lotsResult.error;
            globalError.style.display = 'block';
            alert("Impossible de générer les PDF : " + lotsResult.error);
            return;
        }
        
        generateAllPdfs();
    });
    
    // Fonction pour générer tous les PDF
    function generateAllPdfs() {
        const currentRecipients = currentMode === 'lot-unique' ? recipients : recipientsAlloti;
        
        if (currentRecipients.length === 0) {
            alert("Aucun destinataire à exporter");
            return;
        }
        
        // Créer un seul PDF avec toutes les pages
        const pdf = new jsPDF('p', 'mm', 'a4');
        const fileName = `convocation sous commission DAO N° ${currentMode === 'lot-unique' ? referenceInput.value : referenceInputAlloti.value}.pdf`;
        
        // Fonction récursive pour ajouter chaque page
        function addPageToPdf(index) {
            if (index >= currentRecipients.length) {
                // Toutes les pages ont été ajoutées, télécharger le PDF
                pdf.save(fileName);
                return;
            }
            
            // Rendre l'invitation pour ce destinataire
            const originalMode = viewAllMode;
            viewAllMode = false;
            renderInvitation(index);
            
            setTimeout(() => {
                const element = document.getElementById('invitationDocument');
                
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    // Ajouter une nouvelle page si ce n'est pas la première
                    if (index > 0) {
                        pdf.addPage();
                    }
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    
                    // Passer au destinataire suivant
                    addPageToPdf(index + 1);
                });
                
                // Restaurer le mode d'affichage
                viewAllMode = originalMode;
                if (viewAllMode) {
                    renderAllInvitations();
                }
            }, 500);
        }
        
        // Commencer à ajouter les pages
        addPageToPdf(0);
    }
    
    // Fonction pour générer un PDF
    function generatePdf(recipientIndex) {
        const currentRecipients = currentMode === 'lot-unique' ? recipients : recipientsAlloti;
        
        if (recipientIndex < 0 || recipientIndex >= currentRecipients.length) return;
        
        // Rendre l'invitation pour ce destinataire
        renderInvitation(recipientIndex);
        
        setTimeout(() => {
            const element = document.getElementById('invitationDocument');
            const recipient = currentRecipients[recipientIndex];
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Télécharger le PDF
                pdf.save(`Invitation_${recipient.name.replace(/\s+/g, '_')}.pdf`);
            });
        }, 500);
    }
    
    // Validation des lots en temps réel
    lotsInput.addEventListener('input', function() {
        const lotsResult = formatLots(this.value);
        if (lotsResult.error) {
            lotsError.textContent = lotsResult.error;
            lotsError.style.display = 'block';
            globalError.textContent = lotsResult.error;
            globalError.style.display = 'block';
        } else {
            lotsError.style.display = 'none';
            globalError.style.display = 'none';
            
            // Mettre à jour l'aperçu si on est en mode Alloti
            if (currentMode === 'alloti' && !viewAllMode) {
                const index = parseInt(previewRecipientSelect.value);
                if (!isNaN(index)) {
                    renderInvitation(index);
                }
            }
        }
    });
    
    // Mettre à jour l'aperçu lorsque les champs de date changent
    [dayInput, monthInput, yearInput, hourInput, minuteInput].forEach(input => {
        input.addEventListener('input', function() {
            if (currentMode === 'lot-unique' && !viewAllMode) {
                const index = parseInt(previewRecipientSelect.value);
                if (!isNaN(index)) {
                    renderInvitation(index);
                }
            }
        });
    });
    
    [dayInputAlloti, monthInputAlloti, yearInputAlloti, hourInputAlloti, minuteInputAlloti].forEach(input => {
        input.addEventListener('input', function() {
            if (currentMode === 'alloti' && !viewAllMode) {
                const index = parseInt(previewRecipientSelect.value);
                if (!isNaN(index)) {
                    renderInvitation(index);
                }
            }
        });
    });

    // Appeler l'initialisation des composants
    initializeInvitationComponents();

    // Initialiser le mode par défaut
    btnLotUnique.click();
}

        // --- FONCTIONS D'INITIALISATION ET LOGIQUE POUR CHAQUE FORMULAIRE ---

        // --- LOGIQUE POUR CONVOCATION ---
        function initializeConvocationForm() {
            const sections = {
                "Président & Rep Finance": [
                    { v1: "M. KERBID El Mehdi", v2: "Secrétaire Général du CHU Souss-Massa", v3: "suppléant en cas d'absence du président de la commission", v8: "mkerbid@gmail.com" },
                    { v1: "M. HOUCINE JABBARI", v2: "Contrôleur d'Etat près le CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "h.jabbari@depp.gov.ma" }
                ],
                "DAF": [
                    { v1: "Mme. RAMI Rajaa", v2: "Chef de la division des affaires financières du CHU Souss-Massa", v3: "membre de droit", v8: "rajaa.ramichua@gmail.com" },
                    { v1: "M. OUAYA Lahcen", v2: "Chef du Service de la commande publique du CHU Souss-Massa", v3: "membre de droit", v8: "ouayalahcen@gmail.com" },
                    { v1: "Mme. LACHGAR Rima", v2: "Administrateur 2ème Grade au service de la commande publique du CHU Souss-Massa", v3: "membre de droit", v8: "rimalachgar@gmail.com" },
                    { v1: "Mme. IBN ZAID Fatima EZ-Zahra", v2: "Responsable du Service de la comptabilité du CHU Souss-Massa", v3: "membre de droit", v8: "ibnzaidfatimazahra@gmail.com" },
                    { v1: "Mme. ELMRABET Hanane ", v2: "Responsable du Service de  suivi du recouvrement et des recettes du CHU Souss-Massa", v3: "membre de droit", v8: "elmrabethanane2@gmail.com" }
                ],
                "DPI": [
                    { v1: "M. BELLA Abdoullah", v2: "Chef de la division du patrimoine et de l'ingénierie au CHU Souss-Massa", v3: "membre de droit", v8: "bellaabdoullahchusm@gmail.com" },
                    { v1: "M. EL BAAMRANI Said", v2: "Chef de service de patrimoine, logistique et approvisionnement au CHU Souss-Massa", v3: "membre de droit", v8: "saelbaamrani@gmail.com" },
                    { v1: "Mme. AMAZIANE Fatima Zahrae", v2: "Ingénieur 1er grade au Service de patrimoine, logistique et approvisionnement au CHU Souss-Massa", v3: "membre de droit", v8: "f.zahrae.amaziane@gmail.com" }
                ],
                "PHARMACIE": [
                    { v1: "M. EL YOUBI Zouhair", v2: "Chef de Service de la pharmacie centrale du CHU Souss-Massa", v3: "membre de droit", v8: "zouhair.elyoubi1@gmail.com" },
                    { v1: "M. NAFIA Kamal", v2: "Pharmacien au CHU Souss-Massa", v3: "membre de droit", v8: "kamalnaf367@gmail.com" },
                    { v1: "M. BOUHAL Mohamed Choukri", v2: "Pharmacien au CHU Souss-Massa", v3: "membre de droit", v8: "mohamedchoukri.d@gmail.com" },
                    { v1: "Mme. ABATOUR Latifa", v2: "Pharmacienne au CHU Souss-Massa", v3: "membre de droit", v8: "abatourlatifa@gmail.com" },
                    { v1: "Mme. EL MKIESS Zaineb", v2: "Pharmacienne au CHU Souss-Massa", v3: "membre de droit", v8: "elmkiesszaineb@gmail.com" }
                ],
                "INFORMATIQUE": [
                    { v1: "Mme. EZ-ZAYDY Ikrame", v2: "Chef de Service des systèmes d'information et de l'informatique au CHU Souss-Massa", v3: "membre de droit", v8: "ikrameezzaydy@gmail.com" },
                    { v1: "M. MOUSSAFIR Mustafa", v2: "Ingénieur 1er grade au Service des systèmes d'information et de l'informatique au CHU Souss-Massa", v3: "membre de droit", v8: "moussafirmustafa@gmail.com" },
                    { v1: "M. SLIMANI Ilias", v2: "Ingénieur 1er grade au Service des systèmes d'information et de l'informatique au CHU Souss-Massa", v3: "membre de droit", v8: "iliasslimani@gmail.com" }
                ],
                "AUTRES": [
                    { v1: "M. BATAAL Ali", v2: "Directeur de l'hôpital des spécialités relevant du CHU Souss-Massa", v3: "membre de droit", v8: "alibataal1@gmail.com" },
                    { v1: "M. BOUJELLABA Said", v2: "Directeur de l'hôpital Mère-Enfant relevant du CHU Souss-Massa", v3: "membre de droit", v8: "saad.bouj2020@gmail.com" }
                ]
            };
            const pdfConfigConv = { leftMargin: 20, rightMargin: 20, topMargin: 20, bottomMargin: 30, lineSpacing: 7, paragraphSpacing: 4, fontSize: 11, fontName: 'Cambria' };
            const sectionButtonsDivConv = document.getElementById('convocationSectionButtons');
            const recipientsDivConv = document.getElementById('convocationRecipients');
            const generatePdfButtonConv = document.getElementById('generateConvocationPdfButton');
            let activeSectionButtonConv = null;

            if (sectionButtonsDivConv && !sectionButtonsDivConv.hasChildNodes()) {
                Object.keys(sections).forEach(sectionName => {
                    const button = document.createElement('button');
                    button.type = 'button'; button.textContent = sectionName;
                    button.addEventListener('click', () => displayRecipientsConv(sectionName, button));
                    sectionButtonsDivConv.appendChild(button);
                });
            }
            
            const newGenerateBtnConv = generatePdfButtonConv.cloneNode(true);
            generatePdfButtonConv.parentNode.replaceChild(newGenerateBtnConv, generatePdfButtonConv);
            newGenerateBtnConv.addEventListener('click', handleGeneratePdfClickConv);

            const form = document.getElementById('convocationFormInternal');
            const typeContainer = document.createElement('div');
            typeContainer.className = 'form-group';
            typeContainer.innerHTML = `
                <label for="convocationType">Type d'appel d'offres :</label>
                <select id="convocationType" required>
                    <option value="national">National</option>
                    <option value="international">International</option>
                </select>
            `;
            
            const pricingContainer = document.createElement('div');
            pricingContainer.className = 'form-group';
            pricingContainer.innerHTML = `
                <label for="convocationPricing">Type de marché :</label>
                <select id="convocationPricing" required>
                    <option value="sur offre de prix">Sur offres de prix</option>
                    <option value="à majoration">À majoration</option>
                </select>
            `;
            
            const v5Field = form.querySelector('#convocationV5');
            v5Field.parentNode.insertBefore(typeContainer, v5Field.nextSibling);
            v5Field.parentNode.insertBefore(pricingContainer, typeContainer.nextSibling);

            function formatDateFrConv(dateString) {
                if (!dateString) return '';
                try {
                    const dateObj = new Date(dateString + "T00:00:00");
                    if (isNaN(dateObj.getTime())) { return dateString; }
                    return dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                } catch (e) { return dateString; }
            }
            function formatTimeHmConv(timeString) { return timeString ? timeString.replace(':', 'h') : ''; }
            function sanitizeFilenameConv(name) { return (name || '').replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 50); }

            function displayRecipientsConv(sectionName, clickedButton) {
                if (activeSectionButtonConv) activeSectionButtonConv.classList.remove('active');
                clickedButton.classList.add('active'); activeSectionButtonConv = clickedButton;
                recipientsDivConv.innerHTML = "";

                if (sections[sectionName] && sections[sectionName].length > 0) {
                    const selectAllDiv = document.createElement('div'); selectAllDiv.className = 'select-all-group';
                    const selectAllInput = document.createElement('input'); selectAllInput.type = 'checkbox'; selectAllInput.id = `conv-select-all-${sectionName}`;
                    selectAllInput.addEventListener('change', function() { toggleSelectAllConv(this, sectionName); });
                    const selectAllLabel = document.createElement('label'); selectAllLabel.htmlFor = selectAllInput.id; selectAllLabel.textContent = ' Tout sélectionner / Désélectionner';
                    selectAllDiv.appendChild(selectAllInput); selectAllDiv.appendChild(selectAllLabel); recipientsDivConv.appendChild(selectAllDiv);

                    sections[sectionName].forEach((recipient, index) => {
                        const cbDiv = document.createElement('div'); cbDiv.className = 'checkbox-group';
                        const input = document.createElement('input'); input.type = 'checkbox'; input.name = 'convRecipient'; input.value = JSON.stringify(recipient); input.id = `conv-recipient-${sanitizeFilenameConv(sectionName)}-${index}`;
                        const label = document.createElement('label'); label.htmlFor = input.id; label.textContent = ` ${recipient.v1 || 'N/A'}`;
                        cbDiv.appendChild(input); cbDiv.appendChild(label); recipientsDivConv.appendChild(cbDiv);
                    });
                } else { recipientsDivConv.textContent = "Aucun destinataire."; }
            }
            function toggleSelectAllConv(selectAllCheckbox, sectionName) {
                const isChecked = selectAllCheckbox.checked;
                recipientsDivConv.querySelectorAll('input[name="convRecipient"]').forEach(cb => cb.checked = isChecked);
            }

            function drawSinglePDFPageConv(pdfDoc, recipient, commonData) {
                const { leftMargin, rightMargin, topMargin, lineSpacing, paragraphSpacing, fontSize, fontName } = pdfConfigConv;
                const usableWidth = pdfDoc.internal.pageSize.getWidth() - leftMargin - rightMargin;
                let y = topMargin;

                pdfDoc.setFont(fontName); pdfDoc.setFontSize(fontSize);
                const headerImgUrl = 'https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png';
                const imgWidth = 180, imgHeight = 22;
                pdfDoc.addImage(headerImgUrl, 'PNG', (pdfDoc.internal.pageSize.getWidth() - imgWidth) / 2, y - 10, imgWidth, imgHeight);
                y += imgHeight + lineSpacing;

                pdfDoc.setFont(fontName, 'bold');
                pdfDoc.text("A", pdfDoc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += lineSpacing;
                pdfDoc.text(recipient.v1 || "N/A", pdfDoc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += lineSpacing;
                pdfDoc.setFont(fontName, 'italic');
                pdfDoc.text(recipient.v2 || "N/A", pdfDoc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += lineSpacing * 2;
                
                pdfDoc.setFont(fontName, 'bold');
                pdfDoc.text("Objet : Commission d'ouverture des plis", leftMargin, y); y += lineSpacing;
                pdfDoc.setFont(fontName, 'normal');
                pdfDoc.text(`Réf. : Appel d'Offres Ouvert ${commonData.type === 'international' ? 'International' : 'National'} N° ${commonData.v4 || 'N/A'}`, leftMargin, y); y += lineSpacing * 2;

                const body1 = `Conformément à l'article 38 du Décret n° 2-22-431 du 15 Chaabane 1444 (8 mars 2023) relatif aux marchés publics, j'ai l'honneur de vous demander de bien vouloir assister, en tant que ${recipient.v3 || 'membre'}, à la séance d'ouverture des plis de l'appel d'offre ouvert ${commonData.type === 'international' ? 'international' : 'national'} ${commonData.pricing} N° ${commonData.v4 || 'N/A'} relatif à :`;
                pdfDoc.text(body1, leftMargin, y, { maxWidth: usableWidth, align: 'justify' });
                y += pdfDoc.getTextDimensions(body1, { maxWidth: usableWidth }).h + paragraphSpacing;
                
                pdfDoc.setFont(fontName, 'bold');
                const objetAO = commonData.v5 || 'N/A';
                pdfDoc.text(objetAO, pdfDoc.internal.pageSize.getWidth() / 2, y, { maxWidth: usableWidth, align: 'center' });
                y += pdfDoc.getTextDimensions(objetAO, { maxWidth: usableWidth, align: 'center' }).h + paragraphSpacing;

                pdfDoc.setFont(fontName, 'normal');
                const body2 = `Cette séance aura lieu au siège de la Direction du Centre Hospitalo-Universitaire de Souss-Massa, sis à l'Institut Supérieur des Professions Infirmières et Techniques de Santé (ISPITS) Agadir, le ${formatDateFrConv(commonData.v6)} à ${formatTimeHmConv(commonData.v7)}.`;
                pdfDoc.text(body2, leftMargin, y, { maxWidth: usableWidth, align: 'justify' });
                y += pdfDoc.getTextDimensions(body2, { maxWidth: usableWidth }).h + paragraphSpacing;
                
                pdfDoc.setFont(fontName, 'italic');
                const body3 = `Je porte à votre connaissance que le dossier de l'appel d'Offres vous est transmis par courriel à votre adresse : ${recipient.v8 || 'non spécifiée'}`;
                pdfDoc.text(body3, leftMargin, y, { maxWidth: usableWidth, align: 'justify' });
                y += pdfDoc.getTextDimensions(body3, { maxWidth: usableWidth }).h + lineSpacing * 1.5;

                pdfDoc.setFont(fontName, 'normal');
                const salutation = `Veuillez agréer, ${recipient.v1 && recipient.v1.startsWith('Mme.') ? 'Madame' : 'Monsieur'}, l'expression de mes salutations distinguées.`;
                pdfDoc.text(salutation, leftMargin, y, { maxWidth: usableWidth });
                y += pdfDoc.getTextDimensions(salutation, { maxWidth: usableWidth }).h + lineSpacing * 2;

                const currentDate = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                pdfDoc.setFontSize(10);
                pdfDoc.text(`Fait à Agadir, le ........................`, pdfDoc.internal.pageSize.getWidth() - rightMargin, y, { align: 'right' });

                const footerImgUrl = 'https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png';
                const footerImgHeight = 20;
                pdfDoc.addImage(footerImgUrl, 'PNG', (pdfDoc.internal.pageSize.getWidth() - imgWidth) / 2, pdfDoc.internal.pageSize.getHeight() - footerImgHeight - (pdfConfigConv.bottomMargin / 2) +5, imgWidth, footerImgHeight);
            }

            async function generateAndDownloadSinglePDFConv(recipient, commonData) {
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                drawSinglePDFPageConv(pdf, recipient, commonData);
                pdf.save(`Convocation_${sanitizeFilenameConv(recipient.v1)}_${sanitizeFilenameConv(commonData.v4)}.pdf`);
            }
            async function generateCombinedPDFConv(selectedCheckboxes, commonData) {
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                selectedCheckboxes.forEach((cb, index) => {
                    if (index > 0) pdf.addPage();
                    drawSinglePDFPageConv(pdf, JSON.parse(cb.value), commonData);
                });
                pdf.save(`Convocations_Multiples_${sanitizeFilenameConv(commonData.v4)}.pdf`);
            }

            async function handleGeneratePdfClickConv() {
                const btn = document.getElementById('generateConvocationPdfButton');
                const selectedCBs = recipientsDivConv.querySelectorAll('input[name="convRecipient"]:checked');
                const commonData = {
                    v4: document.getElementById('convocationV4').value,
                    v5: document.getElementById('convocationV5').value,
                    v6: document.getElementById('convocationV6').value,
                    v7: document.getElementById('convocationV7').value,
                    type: document.getElementById('convocationType').value,
                    pricing: document.getElementById('convocationPricing').value
                };
                if (selectedCBs.length === 0) { alert("Sélectionnez destinataire(s)."); return; }
                if (!commonData.v4 || !commonData.v5 || !commonData.v6 || !commonData.v7) { alert("Remplissez les détails AO."); return; }
                
                btn.disabled = true; btn.textContent = 'Génération...';
                try {
                    if (selectedCBs.length === 1) await generateAndDownloadSinglePDFConv(JSON.parse(selectedCBs[0].value), commonData);
                    else await generateCombinedPDFConv(Array.from(selectedCBs), commonData);
                    alert(`${selectedCBs.length} convocation(s) générée(s)!`);
                } catch (err) { alert(`Erreur: ${err.message}`); console.error(err); }
                finally { btn.disabled = false; btn.textContent = 'Générer les Convocations PDF'; }
            }
            
            if (sectionButtonsDivConv && sectionButtonsDivConv.firstChild && typeof sectionButtonsDivConv.firstChild.click === 'function') {
                sectionButtonsDivConv.firstChild.click();
            }
        }

        // --- LOGIQUE POUR BORDEREAU (V1 et Final) ---
        function setupBordereauLogic(type) {
            const wrapperId = `bordereau-${type.toLowerCase()}-form-wrapper`;
            const formWrapper = document.getElementById(wrapperId);
            if (!formWrapper) return;

            const membersList = formWrapper.querySelector(`#membersList${type}`);
            const piecesList = formWrapper.querySelector(`#piecesList${type}`);
            const addMemberButton = formWrapper.querySelector(`#addMember${type}`);
            const addPieceButton = formWrapper.querySelector(`#addPiece${type}`);
            const generatePdfButton = formWrapper.querySelector(`#generateBordereau${type}Pdf`);

            function addDynamicRemoveListener(button, itemClass) {
                button.addEventListener('click', function() {
                    this.closest(itemClass).remove();
                });
            }

            addMemberButton.onclick = () => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `<input type="text" class="member-name" placeholder="Nom du membre"><button type="button" class="remove-member">×</button>`;
                membersList.appendChild(memberItem);
                addDynamicRemoveListener(memberItem.querySelector('.remove-member'), '.member-item');
            };

            addPieceButton.onclick = () => {
                const pieceItem = document.createElement('div');
                pieceItem.className = 'piece-item';
                pieceItem.innerHTML = `<input type="text" class="piece-name" placeholder="Nom de la pièce"><button type="button" class="remove-piece">×</button>`;
                piecesList.appendChild(pieceItem);
                addDynamicRemoveListener(pieceItem.querySelector('.remove-piece'), '.piece-item');
            };
            
            membersList.querySelectorAll('.remove-member').forEach(btn => addDynamicRemoveListener(btn, '.member-item'));
            piecesList.querySelectorAll('.remove-piece').forEach(btn => addDynamicRemoveListener(btn, '.piece-item'));

            generatePdfButton.onclick = function() {
                console.log(`Génération PDF Bordereau ${type} démarrée...`);
                this.textContent = "Génération en cours...";
                this.disabled = true;

                const commissionTitle = formWrapper.querySelector(`#commissionTitle${type}`).value;
                const offerNumber = formWrapper.querySelector(`#offerNumber${type}`).value;
                const offerObject = formWrapper.querySelector(`#offerObject${type}`).value;
                const memberNames = Array.from(membersList.querySelectorAll('.member-name')).map(input => input.value.trim()).filter(name => name);
                const pieceNames = Array.from(piecesList.querySelectorAll('.piece-name')).map(input => input.value.trim()).filter(name => name);

                const pdfContentDiv = formWrapper.querySelector(`#bordereau-content-${type.toLowerCase()}`);
                pdfContentDiv.querySelector(`#pdf-commission-title-${type.toLowerCase()}`).textContent = commissionTitle;
                pdfContentDiv.querySelector(`#pdf-numero-ao-header-${type.toLowerCase()}`).textContent = offerNumber;
                pdfContentDiv.querySelector(`#pdf-numero-ao-body-${type.toLowerCase()}`).textContent = offerNumber;
                pdfContentDiv.querySelector(`#pdf-numero-ao-obs-${type.toLowerCase()}`).textContent = offerNumber;
                pdfContentDiv.querySelector(`#pdf-objet-ao-${type.toLowerCase()}`).textContent = offerObject;
                pdfContentDiv.querySelector(`#pdf-membres-${type.toLowerCase()}`).textContent = memberNames.map(name => `- ${name}`).join('\n');
                
                const pdfPiecesUl = pdfContentDiv.querySelector(`#pdf-pieces-${type.toLowerCase()}`);
                pdfPiecesUl.innerHTML = '';
                pieceNames.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = `${name} ;`;
                    pdfPiecesUl.appendChild(li);
                });

                html2canvas(pdfContentDiv, { scale: 2, useCORS: true, windowHeight: pdfContentDiv.scrollHeight, scrollY: -window.scrollY })
                    .then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgRatio = canvas.width / canvas.height;
                        
                        let finalWidth = pdfWidth;
                        let finalHeight = finalWidth / imgRatio;
                        if (finalHeight > pdfHeight) {
                            finalHeight = pdfHeight;
                            finalWidth = finalHeight * imgRatio;
                        }
                        const posX = (pdfWidth - finalWidth) / 2;
                        const posY = 0;

                        pdf.addImage(imgData, 'PNG', posX, posY, finalWidth, finalHeight);
                        const safeOfferNumber = offerNumber.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                        pdf.save(`bordereau_envoi_${type.toLowerCase()}_${safeOfferNumber}.pdf`);
                    })
                    .catch(err => {
                        console.error(`Erreur html2canvas Bordereau ${type}:`, err);
                        alert(`Erreur capture PDF Bordereau ${type}.`);
                    })
                    .finally(() => {
                        this.textContent = `Générer et Télécharger le PDF ${type}`;
                        this.disabled = false;
                    });
            };
        }

        function initializeBordereauV1Form() {
            setupBordereauLogic('V1');
        }
        function initializeBordereauFinalForm() {
            setupBordereauLogic('Final');
        }

        // --- LOGIQUE POUR DECISION (NOUVELLE VERSION) ---
        function initializeDecisionCommissionForm() {
            const formContainer = document.getElementById('decision-form-content');
            if (!formContainer || formContainer.dataset.initialized === 'true') {
                return;
            }
            
            const sectionsData = {
                "DAF": [
                    { name: "Mme. RAMI Rajaa", role: "Chef de la division des affaires financières du CHU Souss-Massa", quality: "membre de droit", email: "rami@gmail.com" },
                    { name: "M. OUAYA Lahcen", role: "Chef du Service de la commande publique du CHU Souss-Massa", quality: "membre de droit", email: "ouaya@gmail.com" },
                    { name: "Mme. LACHGAR Rima", role: "Administrateur 2ème Grade au service de la commande publique du CHU Souss-Massa", quality: "membre de droit", email: "rimalachgar@gmail.com" },
                    { name: "Mme. IBN ZAID Fatima EZ-Zahra", role: "Responsable du Service de la comptabilité du CHU Souss-Massa", quality: "membre de droit", email: "ibnzaidfatimazahra@gmail.com" },
                    { name: "Mme. ELMRABET Hanane ", role: "Responsable du Service de suivi du recouvrement et des recettes du CHU Souss-Massa", quality: "membre de droit", email: "elmrabethanane2@gmail.com " }
                ],
                "DPI": [
                    { name: "M. BELLA Abdoullah", role: "Chef de la Division du patrimoine et de l'ingénierie du CHU Souss-Massa", quality: "membre de droit", email: "bella@gmail.com" },
                    { name: "M. EL BAAMRANI Said", role: "Chef du Service du patrimoine, logistique et approvisionnement du CHU Souss-Massa", quality: "membre de droit", email: "said@gmail.com" },
                    { name: "Mme. AMAZIANE Fatima Zahrae", role: "Ingénieure 1er Grade au Service du patrimoine, logistique et approvisionnement du CHU Souss-Massa", quality: "membre de droit", email: "f.zahrae.amaziane@gmail.com" },
                    { name: "M. SAAIOU Oussama", role: "Ingénieure 1er Grade au Service des bâtiments et installations techniques du CHU Souss-Massa", quality: "membre de droit", email: "osaaiou@gmail.com" }
                ],
                "Service Pharmacie Centrale": [
                    { name: "M. EL YOUBI Zouhir", role: "Chef du Service de la Pharmacie centrale du centre hospitalo-universitaire Souss-Massa", quality: "membre de droit", email: "zouhair.elyoubi1@gmail.com" },
                    { name: "Mme. EL MKIESS Zaineb", role: "Pharmacienne au Centre Hospitalo-Universitaire Souss Massa", quality: "membre de droit", email: "elmkiesszaineb@gmail.com" },
                    { name: "Mme. ABATOUR Latifa", role: "Pharmacienne au Centre Hospitalo-Universitaire Souss Massa", quality: "membre de droit", email: "abatourlatifa@gmail.com" },
                    { name: "M. NAFIA Kamal", role: "Pharmacien au Centre Hospitalo-Universitaire Souss Massa", quality: "membre de droit", email: "kamalnaf367@gmail.com" },
                    { name: "M. BOUHAL Mohamed Choukri", role: "Pharmacienne au Centre Hospitalo-Universitaire Souss Massa", quality: "membre de droit", email: "mohamedchoukri.d@gmail.com" }
                ],
                "Service Informatique": [
                    { name: "Mme. EZ-ZAYDY Ikrame", role: "Chef du Service Système d'information et Transformation Digitale au CHU Souss-Massa", quality: "membre de droit", email: "i.ezzaydy@chusm.ma" },
                    { name: "M. MOUSSAFIR Mustafa", role: "Ingénieur 1er Grade au Service Système d'information et Transformation Digitale au CHU Souss-Massa", quality: "membre de droit", email: "moussafirmustafa@gmail.com" },
                    { name: "M. SLIMANI Ilias", role: "Ingénieur 1er Grade au Service Système d'information et Transformation Digitale au CHU Souss-Massa", quality: "membre de droit", email: "i.slimani@chusm.ma" }
                ],
                "DOSAP": [
                    { name: "M. BATAAL Ali", role: "Directeur de l'hopital des spécialité relevant du CHU Souss-Massa", quality: "membre de droit", email: "alibataal@gmail.com" },
                    { name: "M. BOUJELLABA Said", role: "Directeur de l'hopital Mère et Enfant relevant du CHU Souss-Massa", quality: "membre de droit", email: "saad.bouj2020@gmail.com" }
                ]
            };

            const selectedMembersContainer = document.getElementById('selectedMembersContainerDecision');
            const sectionsContainer = document.getElementById('sectionsContainerDecision');
            const addMemberBtn = document.getElementById('addMemberBtnDecision');
            const generateBtn = document.getElementById('decisionGenerateBtn');

            selectedMembersContainer.innerHTML = '';
            sectionsContainer.innerHTML = '';
            
            let sectionIndex = 0;
            Object.entries(sectionsData).forEach(([sectionName, members]) => {
                sectionIndex++;
                createSectionDecision(sectionName, members, sectionsContainer, selectedMembersContainer, sectionIndex);
            });
            
            addMemberBtn.addEventListener('click', () => showNewMemberFormDecision(sectionsContainer, selectedMembersContainer, addMemberBtn));
            generateBtn.addEventListener('click', generatePDFDecision);
            
            formContainer.dataset.initialized = 'true';
        }

        function createSectionDecision(sectionName, members, sectionsContainer, selectedMembersContainer, sectionIndex) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = `glass-card overflow-hidden fade-in delay-3 section-${sectionIndex}`;
            
            const sectionHeader = document.createElement('button');
            sectionHeader.className = 'w-full px-5 py-4 flex justify-between items-center text-left focus:outline-none';
            sectionHeader.innerHTML = `
                <div class="flex items-center">
                    <div class="bg-secondary/20 p-2 rounded-lg mr-3">
                        <svg class="w-5 h-5 text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                    </div>
                    <span class="font-medium text-black">${sectionName}</span>
                </div>
                <svg class="w-5 h-5 text-black transform transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
            `;
            
            const sectionContent = document.createElement('div');
            sectionContent.className = 'section-content max-h-0 overflow-hidden transition-all duration-500 ease-in-out';
            
            members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-element flex flex-col px-5 py-3 hover:bg-black/5 cursor-pointer transition-colors duration-200 rounded-lg m-2';
                memberElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-black">${member.name}</div>
                            <div class="text-sm text-black/70">${member.role}</div>
                        </div>
                        <div class="bg-primary/20 text-primary px-3 py-1 rounded-full text-xs font-medium">${member.quality}</div>
                    </div>
                    <div class="error-message mt-1 hidden text-red-500 text-xs">This person is already chosen</div>
                `;
                memberElement.dataset.name = member.name;
                memberElement.dataset.role = member.role;
                memberElement.dataset.quality = member.quality;
                
                memberElement.addEventListener('click', function() {
                    const memberText = `${member.name} : ${member.role}`;
                    const existingMembers = selectedMembersContainer.querySelectorAll('.member-item input');
                    let alreadyExists = false;
                    
                    for (const input of existingMembers) {
                        if (input.value === memberText) {
                            alreadyExists = true;
                            break;
                        }
                    }
                    
                    if (alreadyExists) {
                        // Animation de clignotement rouge
                        this.classList.add('animate-blink');
                        const errorMessage = this.querySelector('.error-message');
                        errorMessage.classList.remove('hidden');
                        
                        setTimeout(() => {
                            this.classList.remove('animate-blink');
                            errorMessage.classList.add('hidden');
                        }, 1500);
                        return;
                    }
                    
                    addSelectedMemberDecision(
                        member.name, 
                        member.role, 
                        member.quality, 
                        selectedMembersContainer
                    );
                    
                    this.classList.add('animate-pulse');
                    setTimeout(() => {
                        this.classList.remove('animate-pulse');
                    }, 400);
                });
                
                sectionContent.appendChild(memberElement);
            });
            
            sectionHeader.addEventListener('click', function() {
                document.querySelectorAll('.section-content').forEach(content => {
                    if (content !== sectionContent && content.style.maxHeight !== '0px') {
                        content.style.maxHeight = '0';
                        const icon = content.previousElementSibling.querySelector('svg:last-child');
                        icon.classList.remove('rotate-45');
                        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />`;
                    }
                });
                
                const isOpen = sectionContent.style.maxHeight !== '0px';
                sectionContent.style.maxHeight = isOpen ? '0' : `${sectionContent.scrollHeight}px`;
                
                const icon = this.querySelector('svg:last-child');
                icon.classList.toggle('rotate-45', !isOpen);
                 if (!isOpen) {
                    icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />`;
                } else {
                    icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />`;
                }
            });
            
            sectionDiv.appendChild(sectionHeader);
            sectionDiv.appendChild(sectionContent);
            sectionsContainer.appendChild(sectionDiv);
        }
        
        function showNewMemberFormDecision(sectionsContainer, selectedMembersContainer, addMemberBtnRef) {
            addMemberBtnRef.style.display = 'none';
            
            const formDiv = document.createElement('div');
            formDiv.className = 'glass-card p-5 mt-4 fade-in section-7';
            formDiv.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-black/80 mb-2">Nom et prénom du membre</label>
                        <input type="text" id="newMemberNameDecision" class="input-glass w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary" placeholder="Ex: Dr. BATAAL Ali">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-black/80 mb-2">Fonction/Rôle</label>
                        <input type="text" id="newMemberRoleDecision" class="input-glass w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary" placeholder="Ex: Directeur Général du Centre Hospitalo-Universitaire Souss-Massa PI">
                    </div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button id="cancelCustomMemberBtnDecision" class="px-5 py-2 rounded-lg font-medium bg-black/10 hover:bg-black/20 transition-colors duration-200">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </button>
                        <button id="confirmCustomMemberBtnDecision" class="px-5 py-2 rounded-lg font-medium bg-primary hover:bg-primary/80 transition-colors duration-200 text-white">
                            <i class="fas fa-check mr-2"></i>Ajouter
                        </button>
                    </div>
                </div>
            `;
            
            sectionsContainer.appendChild(formDiv);
            
            document.getElementById('confirmCustomMemberBtnDecision').addEventListener('click', function() {
                const name = document.getElementById('newMemberNameDecision').value.trim();
                const role = document.getElementById('newMemberRoleDecision').value.trim();
                
                if (name && role) {
                    addSelectedMemberDecision(name, role, "", selectedMembersContainer);
                    
                    const newMember = selectedMembersContainer.lastChild;
                    newMember.style.opacity = '0';
                    newMember.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        newMember.style.opacity = '1';
                        newMember.style.transform = 'translateY(0)';
                    }, 10);
                    
                    sectionsContainer.removeChild(formDiv);
                    addMemberBtnRef.style.display = 'flex';
                } else {
                    const inputs = [
                        document.getElementById('newMemberNameDecision'),
                        document.getElementById('newMemberRoleDecision')
                    ];
                    inputs.forEach(input => {
                        if (!input.value.trim()) {
                            input.classList.add('animate-shake');
                            setTimeout(() => {
                                input.classList.remove('animate-shake');
                            }, 500);
                        }
                    });
                }
            });
            
            document.getElementById('cancelCustomMemberBtnDecision').addEventListener('click', function() {
                formDiv.classList.add('animate-fade-out');
                setTimeout(() => {
                    if(formDiv.parentNode) {
                       sectionsContainer.removeChild(formDiv);
                    }
                    addMemberBtnRef.style.display = 'flex';
                }, 300);
            });
        }
        
        function addSelectedMemberDecision(name, role, quality, selectedMembersContainer) {
            const memberText = `${name} : ${role}`;
            
            const existingMembers = selectedMembersContainer.querySelectorAll('.member-item');
            for (const member of existingMembers) {
                if (member.querySelector('input').value === memberText) {
                    member.classList.add('bg-accent/10', 'border-l-4', 'border-accent', 'animate-shake');
                    setTimeout(() => {
                        member.classList.remove('bg-accent/10', 'border-l-4', 'border-accent', 'animate-shake');
                    }, 1000);
                    return;
                }
            }
            
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-item glass-card flex items-center justify-between p-3 mb-3 transition-all duration-300 selected-member';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = memberText;
            input.readOnly = true;
            input.className = 'input-glass flex-1 bg-transparent focus:outline-none border-none p-0';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'ml-3 p-2 rounded-lg hover:bg-black/10 transition-colors duration-200 text-black/70 hover:text-black';
            removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            removeBtn.addEventListener('click', function() {
                memberDiv.classList.add('animate-fade-out');
                setTimeout(() => {
                    if (memberDiv.parentNode) {
                        selectedMembersContainer.removeChild(memberDiv);
                    }
                }, 300);
            });
            
            memberDiv.appendChild(input);
            memberDiv.appendChild(removeBtn);
            selectedMembersContainer.appendChild(memberDiv);

            memberDiv.style.opacity = '0';
            memberDiv.style.transform = 'translateY(10px)';
            setTimeout(() => {
                memberDiv.style.opacity = '1';
                memberDiv.style.transform = 'translateY(0)';
            }, 50);
        }
        
        function generatePDFDecision() {
            const tenderNumber = document.getElementById('tenderNumberDecision').value.trim();
            const tenderTypeInput = document.querySelector('input[name="tenderTypeDecision"]:checked');
            const tenderModeInput = document.querySelector('input[name="tenderModeDecision"]:checked');
            const tenderObject = document.getElementById('tenderObjectDecision').value.trim();
            const president = document.getElementById('presidentDecision').value;
            const suppleant = document.getElementById('suppleantDecision').value;
            
            // Nettoyer les messages d'erreur globaux
            const globalErrors = document.getElementById('globalErrors');
            globalErrors.innerHTML = '';
            
            let formIsValid = true;
            const errors = [];

            // Validation des champs obligatoires
            if (!tenderNumber) {
                const el = document.getElementById('tenderNumberDecision');
                el.classList.add('animate-shake', 'border-red-500');
                setTimeout(() => el.classList.remove('animate-shake', 'border-red-500'), 600);
                errors.push("Le numéro d'appel d'offres est obligatoire");
                formIsValid = false;
            }
            if (!tenderObject) {
                 const el = document.getElementById('tenderObjectDecision');
                el.classList.add('animate-shake', 'border-red-500');
                setTimeout(() => el.classList.remove('animate-shake', 'border-red-500'), 600);
                errors.push("L'objet de l'appel d'offres est obligatoire");
                formIsValid = false;
            }
            if (!tenderTypeInput) {
                const radioContainer = document.querySelector('input[name="tenderTypeDecision"]').closest('div.flex');
                if (radioContainer) {
                    radioContainer.classList.add('ring-2', 'ring-red-500', 'rounded-lg');
                     setTimeout(() => radioContainer.classList.remove('ring-2', 'ring-red-500', 'rounded-lg'), 1000);
                }
                errors.push("Le type d'appel d'offres est obligatoire");
                formIsValid = false;
            }
            
            const members = [];
            const memberInputs = document.querySelectorAll('#selectedMembersContainerDecision input');
            memberInputs.forEach(input => { members.push(input.value); });
            
            if (members.length === 0) {
                errors.push("Au moins un membre doit être sélectionné");
                formIsValid = false;
            }
            
            // Afficher les erreurs globales
            if (errors.length > 0) {
                errors.forEach(error => {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-2 fade-in';
                    errorDiv.textContent = error;
                    globalErrors.appendChild(errorDiv);
                });
                
                globalErrors.scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            const tenderType = tenderTypeInput.value;
            const tenderMode = tenderModeInput ? tenderModeInput.value : 'sur offre';

            const generateBtn = document.getElementById('decisionGenerateBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Génération en cours...';
            generateBtn.disabled = true;
            
            // Créer des images de base64 pour éviter les problèmes CORS
            const headerImage = new Image();
            const footerImage = new Image();
            
            headerImage.crossOrigin = "Anonymous";
            footerImage.crossOrigin = "Anonymous";
            
            headerImage.src = 'https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png';
            footerImage.src = 'https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png';
            
            let imagesLoaded = 0;
            
            function onImageLoad() {
                imagesLoaded++;
                if (imagesLoaded === 2) {
                    generatePDFWithImages();
                }
            }
            
            function onImageError() {
                imagesLoaded++;
                if (imagesLoaded === 2) {
                    generatePDFWithImages();
                }
            }
            
            headerImage.onload = onImageLoad;
            footerImage.onload = onImageLoad;
            headerImage.onerror = onImageError;
            footerImage.onerror = onImageError;
            
            function generatePDFWithImages() {
                try {
                    const doc = new jsPDF({
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    // Marges de 2cm (20mm) gauche et droite
                    const leftMargin = 20;
                    const rightMargin = 20;
                    const contentWidth = pageWidth - leftMargin - rightMargin;
                    let yPos = 30;
                    const lineHeight = 5;
                    
                    // En-tête
                    try {
                        doc.addImage(headerImage, 'PNG', 15, 5, pageWidth - 30, 20);
                        yPos = 35;
                    } catch (e) {
                        console.log("Erreur avec l'image d'en-tête, continuation sans image");
                    }
                    
                    // Titre en gras avec marges de 2cm - Numéro dans la même ligne
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    
                    doc.text('DECISION', pageWidth / 2, yPos, { align: 'center' });
                    yPos += 6;
                    
                    doc.text('PORTANT NOMINATION DES MEMBRES', pageWidth / 2, yPos, { align: 'center' });
                    yPos += 6;
                    
                    const typeText = tenderType === 'international' ? 'OUVERT INTERNATIONAL' : 'NATIONAL';
                    const modeText = tenderMode === 'à majoration' ? 'À MAJORATION' : 'SUR OFFRES DE PRIX';
                    // Numéro dans la même ligne après "PRIX"
                    const commissionText = `DE LA COMMISSION DE L'APPEL D'OFFRES ${typeText} ${modeText} ${tenderNumber.toUpperCase()}`;
                    const commissionLines = doc.splitTextToSize(commissionText, contentWidth);
                    commissionLines.forEach(line => {
                        doc.text(line, pageWidth / 2, yPos, { align: 'center' });
                        yPos += 6;
                    });
                    
                    yPos += 4;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(12); // Réduction de 2 points
                    const directorLines = doc.splitTextToSize('LE DIRECTEUR DU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS-MASSA', contentWidth);
                    directorLines.forEach(line => {
                        doc.text(line, pageWidth / 2, yPos, { align: 'center' });
                        yPos += 6;
                    });
                    
                    yPos += 6;
                    doc.setFontSize(10);
                    const decreeLines = doc.splitTextToSize('Vu le Décret n° 2-22-431 du 15 chaabane 1444 (8 mars 2023) relatif aux marchés publics.', contentWidth);
                    decreeLines.forEach(line => {
                        doc.text(line, leftMargin, yPos, { align: 'justify' });
                        yPos += lineHeight;
                    });
                    
                    yPos += 6;
                    doc.setFont(undefined, 'bold'); // DECIDE en gras
                    doc.setFontSize(12);
                    doc.text('DECIDE', pageWidth / 2, yPos, { align: 'center' });
                    
                    yPos += 10;
                    
                    // Paragraphe principal justifié et non gras avec marges de 2cm
                    doc.setFont(undefined, 'normal');
                    const commissionParagraphText = `En plus du représentant du ministre chargé des finances, la commission d'appel d'offres`;
                    const tenderParagraphText = `chargée d'examiner les offres relatives à l'appel d'offres ${tenderType === 'international' ? 'ouvert international' : 'national'} ${tenderMode === 'à majoration' ? 'à majoration' : 'sur offres de prix'}`;
                    const refParagraphText = `${tenderNumber.toUpperCase()} relatif à :`;
                    const fullText = `${commissionParagraphText} ${tenderParagraphText} ${refParagraphText}`;
                    
                    const paragraphLines = doc.splitTextToSize(fullText, contentWidth);
                    paragraphLines.forEach(line => {
                        if (yPos > pageHeight - 40) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(line, leftMargin, yPos, { align: 'justify' });
                        yPos += lineHeight;
                    });
                    
                    // Objet sans espace avant et après avec marges de 2cm
                    yPos += 4;
                    doc.setFont(undefined, 'bold');
                    const objectLines = doc.splitTextToSize(tenderObject.toUpperCase(), contentWidth);
                    objectLines.forEach(line => {
                        if (yPos > pageHeight - 40) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(line, pageWidth / 2, yPos, { align: 'center' });
                        yPos += lineHeight;
                    });
                    
                    doc.setFont(undefined, 'normal');
                    yPos += 4;
                    
                    if (yPos > pageHeight - 40) {
                        doc.addPage();
                        yPos = 30;
                    }
                    doc.text('Est composée comme suit :', leftMargin, yPos);
                    
                    // Suppression des espaces avant et après les paragraphes avec marges de 2cm
                    yPos += 8;
                    doc.setFont(undefined, 'bold');
                    doc.text('ARTICLE UNIQUE :', leftMargin, yPos);
                    
                    yPos += 5;
                    doc.text('PRESIDENT :', leftMargin, yPos);
                    doc.setFont(undefined, 'normal');
                    
                    yPos += 5;
                    // Extraire le nom du président pour le mettre en gras
                    const presidentName = president.split(':')[0].trim();
                    const presidentRole = president.split(':')[1].trim();
                    
                    // Écrire le nom en gras
                    doc.setFont(undefined, 'bold');
                    doc.text('- ' + presidentName + ' :', leftMargin + 5, yPos);
                    const nameWidth = doc.getTextWidth('- ' + presidentName + ' :');
                    
                    // Écrire le rôle en normal
                    doc.setFont(undefined, 'normal');
                    const roleLines = doc.splitTextToSize(presidentRole, contentWidth - 5 - nameWidth);
                    if (roleLines.length > 0) {
                        doc.text(roleLines[0], leftMargin + 5 + nameWidth, yPos);
                        yPos += lineHeight;
                        
                        // Continuer les lignes suivantes du rôle
                        for (let i = 1; i < roleLines.length; i++) {
                            if (yPos > pageHeight - 40) {
                                doc.addPage();
                                yPos = 30;
                            }
                            doc.text(roleLines[i], leftMargin + 5, yPos);
                            yPos += lineHeight;
                        }
                    } else {
                        yPos += lineHeight;
                    }
                    
                    yPos += 4;
                    doc.setFont(undefined, 'bold');
                    const suppleantIntroText = 'En cas d\'absence ou empêchement du président, la suppléance sera assurée par :';
                    const suppleantIntroLines = doc.splitTextToSize(suppleantIntroText, contentWidth);
                    suppleantIntroLines.forEach(line => {
                        if (yPos > pageHeight - 40) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(line, leftMargin, yPos, { align: 'justify' });
                        yPos += lineHeight;
                    });
                    
                    doc.setFont(undefined, 'normal');
                    
                    yPos += 3;
                    // Extraire le nom du suppléant pour le mettre en gras
                    const suppleantName = suppleant.split(':')[0].trim();
                    const suppleantRole = suppleant.split(':')[1].trim();
                    
                    // Écrire le nom en gras
                    doc.setFont(undefined, 'bold');
                    doc.text('- ' + suppleantName + ' :', leftMargin + 5, yPos);
                    const suppleantNameWidth = doc.getTextWidth('- ' + suppleantName + ' :');
                    
                    // Écrire le rôle en normal
                    doc.setFont(undefined, 'normal');
                    const suppleantRoleLines = doc.splitTextToSize(suppleantRole, contentWidth - 5 - suppleantNameWidth);
                    if (suppleantRoleLines.length > 0) {
                        doc.text(suppleantRoleLines[0], leftMargin + 5 + suppleantNameWidth, yPos);
                        yPos += lineHeight;
                        
                        // Continuer les lignes suivantes du rôle
                        for (let i = 1; i < suppleantRoleLines.length; i++) {
                            if (yPos > pageHeight - 40) {
                                doc.addPage();
                                yPos = 30;
                            }
                            doc.text(suppleantRoleLines[i], leftMargin + 5, yPos);
                            yPos += lineHeight;
                        }
                    } else {
                        yPos += lineHeight;
                    }
                    
                    yPos += 6;
                    doc.setFont(undefined, 'bold');
                    doc.text('MEMBRES :', leftMargin, yPos);
                    doc.setFont(undefined, 'normal');
                    
                    // Membres - Suppression des espaces supplémentaires, "(membre de droit)" et JUSTIFICATION avec marges de 2cm
                    members.forEach(member => {
                        yPos += 4;
                        if (yPos > pageHeight - 40) {
                            doc.addPage();
                            yPos = 30;
                        }
                        
                        // Supprimer "(membre de droit)" du texte du membre
                        const cleanMemberText = member.replace(/ \(membre de droit\)/g, '');
                        
                        // Extraire le nom du membre pour le mettre en gras
                        const memberName = cleanMemberText.split(':')[0].trim();
                        const memberRole = cleanMemberText.split(':')[1].trim();
                        
                        // Écrire le nom en gras
                        doc.setFont(undefined, 'bold');
                        doc.text('- ' + memberName + ' :', leftMargin + 5, yPos);
                        const memberNameWidth = doc.getTextWidth('- ' + memberName + ' :');
                        
                        // Écrire le rôle en normal
                        doc.setFont(undefined, 'normal');
                        const memberRoleLines = doc.splitTextToSize(memberRole, contentWidth - 5 - memberNameWidth);
                        if (memberRoleLines.length > 0) {
                            doc.text(memberRoleLines[0], leftMargin + 5 + memberNameWidth, yPos);
                            yPos += lineHeight;
                            
                            // Continuer les lignes suivantes du rôle
                            for (let i = 1; i < memberRoleLines.length; i++) {
                                if (yPos > pageHeight - 40) {
                                    doc.addPage();
                                    yPos = 30;
                                }
                                doc.text(memberRoleLines[i], leftMargin + 5, yPos);
                                yPos += lineHeight;
                            }
                        } else {
                            yPos += lineHeight;
                        }
                    });
                    
                    yPos += 6;
                    if (yPos > pageHeight - 40) {
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    const finalText = 'Il s\'adjoint à la commission d\'ouverture des plis à titre consultatif toute autre personne dont la présence est jugée utile pour l\'accomplissement de sa mission.';
                    const finalLines = doc.splitTextToSize(finalText, contentWidth);
                    finalLines.forEach(line => {
                        if (yPos > pageHeight - 40) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(line, leftMargin, yPos, { align: 'justify' });
                        yPos += lineHeight;
                    });
                    
                    // Pied de page sur la première page seulement
                    try {
                        doc.addImage(footerImage, 'PNG', 15, pageHeight - 20, pageWidth - 30, 12);
                    } catch (e) {
                        console.log("Erreur avec l'image de pied de page");
                    }
                    
                    // Sauvegarder le PDF
                    const safeFileName = 'Decision_Nomination_' + tenderNumber.replace(/[\/\s]/g, '_') + '.pdf';
                    doc.save(safeFileName);
                    
                } catch (error) {
                    console.error("Erreur lors de la génération du PDF:", error);
                    alert("Une erreur est survenue lors de la génération du PDF: " + error.message);
                } finally {
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                }
            }
        }

        // --- LOGIQUE POUR DEMANDE DE COMPLEMENT - CORRIGÉ ---
        function initializeComplementForm() {
            const { jsPDF } = window.jspdf;
            
            // Mode selection
            const multiLotBtn = document.getElementById('multiLotBtn');
            const singleLotBtn = document.getElementById('singleLotBtn');
            const multiLotSection = document.getElementById('multiLotSection');
            const singleLotSection = document.getElementById('singleLotSection');
            
            // Multi-lot elements
            const addSocieteBtn = document.getElementById('addSocieteBtn');
            const generateMultiBtn = document.getElementById('generateMultiBtn');
            const societesTableBody = document.getElementById('societesTableBody');
            const statusMultiDiv = document.getElementById('statusMulti');
            
            // Single-lot elements
            const addConditionBtn = document.getElementById('addConditionBtn');
            const generateSingleBtn = document.getElementById('generateSingleBtn');
            const singleConditionsContainer = document.getElementById('singleConditionsContainer');
            const statusSingleDiv = document.getElementById('statusSingle');
            
            // --- CONDITIONS PAR DÉFAUT ---
            const defaultConditions = [
                "Compléter le dossier Administratif conformément à l'article N°05 du règlement de consultation",
            ];
            
            // --- FONCTIONS UTILITAIRES ---
            
            function addConditionField(container, text = '') {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'condition-item';
                
                const textArea = document.createElement('input');
                textArea.type = 'text';
                textArea.className = 'form-control condition-input';
                textArea.value = text;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm remove-condition';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.title = 'Supprimer cette condition';
                removeBtn.onclick = () => {
                    if (container.querySelectorAll('.condition-item').length > 1) {
                        itemDiv.remove();
                    } else {
                        alert('Vous devez avoir au moins une condition.');
                    }
                };
                
                itemDiv.appendChild(textArea);
                itemDiv.appendChild(removeBtn);
                container.appendChild(itemDiv);
            }
            
            function addSocieteRow() {
                const row = societesTableBody.insertRow();
                row.className = 'societe-row';
                
                const cellName = row.insertCell();
                const cellLots = row.insertCell();
                const cellConditions = row.insertCell();
                const cellNote = row.insertCell();
                const cellActions = row.insertCell();
                
                cellName.innerHTML = `<input type="text" class="form-control companyName" placeholder="Nom de la société">`;
                cellLots.innerHTML = `<textarea class="form-control lots" placeholder="Ex: 1, 2, 15"></textarea><div class="error-message"></div>`;
                
                const conditionsContainer = document.createElement('div');
                conditionsContainer.className = 'conditions-container';
                cellConditions.appendChild(conditionsContainer);
                
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'btn btn-primary btn-sm';
                addBtn.innerHTML = '<i class="fas fa-plus mr-1"></i> Ajouter une condition';
                addBtn.onclick = () => addConditionField(conditionsContainer);
                cellConditions.appendChild(addBtn);
                
                defaultConditions.forEach(condText => addConditionField(conditionsContainer, condText));
                
                cellNote.innerHTML = `<textarea class="form-control specific-note" placeholder="Note optionnelle..."></textarea>`;
                cellActions.innerHTML = `<button type="button" class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button>`;
                
                row.querySelector('.remove-row').addEventListener('click', () => row.remove());
            }
            
            function processLots(lotsInput) {
                const lotsRaw = lotsInput.split(',').map(l => l.trim()).filter(l => l !== '');
                let validLots = [];
                let errorMessages = [];
                let hasDuplicate = false;
                
                const seenInRow = new Set();
                for (const lot of lotsRaw) {
                    if (!/^\d+$/.test(lot)) {
                        errorMessages.push(`'${lot}' n'est pas un chiffre.`);
                    } else {
                        if (seenInRow.has(lot)) {
                            errorMessages.push(`Le lot '${lot}' est un doublon.`);
                            hasDuplicate = true;
                        } else {
                            seenInRow.add(lot);
                            validLots.push(lot);
                        }
                    }
                }
                
                const allLots = [];
                const allRows = document.querySelectorAll('.societe-row');
                allRows.forEach(row => {
                    const rowLots = row.querySelector('.lots').value.split(',').map(l => l.trim()).filter(l => l !== '' && /^\d+$/.test(l));
                    allLots.push(...rowLots);
                });
                
                const duplicateLots = allLots.filter((lot, index) => allLots.indexOf(lot) !== index);
                if (duplicateLots.length > 0) {
                    errorMessages.push(`Attention: Le(s) lot(s) ${[...new Set(duplicateLots)].join(', ')} apparaissent plusieurs fois dans le tableau.`);
                    hasDuplicate = true;
                }
                
                validLots.sort((a, b) => a - b);
                return { lots: validLots, error: errorMessages.join(' '), hasDuplicate };
            }
            
            function generateMultiPageHtml(data) {
                const lotsText = data.lots.length > 0 ? `lot N°${data.lots.join(', lot N°')}` : '[AUCUN LOT SPÉCIFIÉ]';
                
                const conditionsHtml = data.conditions.length > 0 
                    ? `<ul>${data.conditions.map(c => `<li style="text-align: justify; margin-bottom: 10px;">${c}</li>`).join('')}</ul>`
                    : '<p>Aucune condition spécifiée.</p>';
                    
                const specificNoteHtml = data.specificNote ? `<p style="text-align: justify; font-weight: bold;">NB :<br>${data.specificNote}</p>` : '';
                
                return `
                    <div class="complement-pdf-content">
                        <div style="text-align: center; margin-bottom: 10mm;">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="En-tête du document" style="width: 100%; max-width: 180mm;">
                        </div>
                        
                        <h1 style="text-align: center; margin: 0; font-size: 18px; color: black;">A</h1>
                        <div style="text-align: center; font-weight: bold; margin: 1px 0 30px 0; font-size: 18px;">Monsieur le Gérant de la société<br> <span style="text-transform: uppercase;">${data.companyName}</span>
                        </div>
                        <p class="subject"><strong><u>Objet : Demande de complément du dossier administratif</u></strong></p>
                       <p><strong><u>Réf : Appel d'Offres N° ${data.refNumber}</u></strong></p>
                        <p style="text-align: justify;"><strong><i>J</strong></i>'ai l'honneur de vous informer que votre offre pour les lots suivants :</p>
                        <p style="text-align: justify; font-weight: bold;"> - ${lotsText}</p>
                        <p style="text-align: justify;">Relative à l'appel d'offres ouvert ${data.offerType} sur offres de prix <b>N° ${data.refNumber}</b> ayant pour objet : "<b>${data.offerObject}</b>", a été retenue provisoirement dans l'attente de :</p>
                        ${conditionsHtml}
                        ${specificNoteHtml}
                        <p style="text-align: justify;"><strong><i>V</strong></i>euillez agréer, Monsieur, l'expression de mes sincères salutations.</p>
                        <p style="text-align: right; margin-top: 40px;">Agadir, le .........................</p>
                        
                        <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" style="width: 100%; position: absolute; bottom: 3mm; left: 0; padding: 5 10mm; box-sizing: border-box;">
                    </div>`;
            }
            
            function generateSinglePageHtml(data) {
                const conditionsHtml = data.conditions.length > 0 
                    ? `<ul>${data.conditions.map(c => `<li class="justify-text">${c}.</li>`).join('')}</ul>`
                    : '<p>Aucune condition spécifiée.</p>';
                
                const noteHtml = data.note ? `
                    <p class="justify-text"><strong>NB :</strong></p>
                    <p class="note-content justify-text">${data.note}</p>
                ` : '';
                
                return `
                    <div class="complement-pdf-content">
                        <div style="text-align: center; margin-bottom: 0px;">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" style="width: 100%; max-width: 700px; margin-bottom: 10px;">
                        </div>
                        
                        <div style="text-align: center; font-weight: bold; margin: 30px 0 0 0; font-size: 18px;">
                            <h1 style="margin-top: 30px; margin-bottom: 0; font-size:1.2em; color: black;">A</h1>
                            Monsieur le Gérant de la société<br> <span style="text-transform: uppercase;">${data.companyName}</span>
                        </div>
                        
                        <p style="text-align: left; font-weight: bold; margin: 15px 0;"><strong><u>Objet : Demande de complément du dossier administratif</u></strong></p>
                        <p style="text-align: left; margin: 15px 0;"><strong><u>Réf : Appel d'Offres N° ${data.refNumber}</strong></p></u>
                        <p style="text-align: justify;"><strong><i>J</strong></i>'ai l'honneur de vous informer que votre offre relative à l'appel d'offres ouvert ${data.offerType} ${data.pricingType} <strong> N° ${data.refNumber}</strong> ayant pour objet : "<strong>${data.offerObject}</strong>", a été retenue provisoirement dans l'attente de :</p>
                        
                        ${conditionsHtml}
                        ${noteHtml}
                        
                        <p style="text-align: justify; margin-top: 30px;"><strong><i>V</strong></i>euillez agréer, Monsieur, l'expression de mes sincères salutations.</p>
                        <div style="text-align: right; margin-top: 50px;">
                            Agadir, le .........................
                        </div>
                        
                        <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" style="width: 100%; position: absolute; bottom: 3mm; left: 0; padding: 5 10mm; box-sizing: border-box;">
                    </div>`;
            }
            
            async function generatePDFFromHtml(htmlContent, fileName) {
                return new Promise((resolve, reject) => {
                    const elementToRender = document.createElement('div');
                    elementToRender.className = 'complement-pdf-render-area';
                    elementToRender.innerHTML = htmlContent;
                    document.body.appendChild(elementToRender);
                    
                    const content = elementToRender.querySelector('.complement-pdf-content');
                    
                    const options = {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        width: content.scrollWidth,
                        height: content.scrollHeight,
                        windowWidth: content.scrollWidth,
                        windowHeight: content.scrollHeight
                    };
                    
                    html2canvas(content, options)
                        .then(canvas => {
                            const doc = new jsPDF({
                                orientation: 'portrait',
                                unit: 'mm',
                                format: 'a4'
                            });
                            
                            const pageWidth = doc.internal.pageSize.getWidth();
                            const pageHeight = doc.internal.pageSize.getHeight();
                            
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = pageWidth;
                            const imgHeight = (canvas.height * pageWidth) / canvas.width;
                            
                            doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                            doc.save(fileName);
                            
                            document.body.removeChild(elementToRender);
                            resolve(true);
                        })
                        .catch(error => {
                            console.error('Erreur lors de la génération du PDF :', error);
                            document.body.removeChild(elementToRender);
                            reject(error);
                        });
                });
            }
            
            async function generateMultiPagePDF() {
                statusMultiDiv.textContent = 'Validation des données...';
                const commonData = {
                    refNumber: document.getElementById('refNumber').value.trim(),
                    offerType: document.getElementById('offerType').value,
                    offerObject: document.getElementById('offerObject').value.trim(),
                };
                
                if (!commonData.refNumber || !commonData.offerObject) {
                    alert("Veuillez remplir les informations de l'appel d'offres (N° et Objet).");
                    statusMultiDiv.textContent = '';
                    return;
                }
                
                const rows = document.querySelectorAll('.societe-row');
                if (rows.length === 0) {
                    alert("Veuillez ajouter au moins une société.");
                    statusMultiDiv.textContent = '';
                    return;
                }
                
                const allCompanyData = [];
                let isValid = true;
                let hasDuplicateLots = false;
                
                rows.forEach((row) => {
                    const companyName = row.querySelector('.companyName').value.trim();
                    const lotsInput = row.querySelector('.lots').value;
                    const errorDiv = row.querySelector('.error-message');
                    
                    const lotProcessingResult = processLots(lotsInput);
                    errorDiv.textContent = lotProcessingResult.error;
                    
                    const conditions = Array.from(row.querySelectorAll('.condition-input'))
                                          .map(input => input.value.trim())
                                          .filter(text => text);
                    
                    const specificNote = row.querySelector('.specific-note').value.trim();
                    
                    if (!companyName || lotProcessingResult.lots.length === 0 || conditions.length === 0 || lotProcessingResult.error) {
                        isValid = false;
                        row.style.backgroundColor = '#ffdddd';
                    } else {
                        row.style.backgroundColor = '';
                        allCompanyData.push({ ...commonData, companyName, lots: lotProcessingResult.lots, conditions, specificNote });
                    }
                    
                    if (lotProcessingResult.hasDuplicate) {
                        hasDuplicateLots = true;
                    }
                });
                
                if (!isValid) {
                    alert("Vérifiez les lignes en rouge. Chaque société doit avoir un nom, au moins un lot valide, et au moins une condition.");
                    statusMultiDiv.textContent = 'Erreur de validation.';
                    return;
                }
                
                if (hasDuplicateLots) {
                    alert("Des numéros de lot sont en doublon dans le tableau. Veuillez corriger avant de générer le PDF.");
                    statusMultiDiv.textContent = 'Erreur: doublons détectés dans les numéros de lot.';
                    return;
                }
                
                statusMultiDiv.textContent = 'Génération du PDF en cours... Veuillez patienter.';
                
                try {
                    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                    
                    for (let i = 0; i < allCompanyData.length; i++) {
                        const data = allCompanyData[i];
                        statusMultiDiv.textContent = `Génération de la page ${i + 1}/${allCompanyData.length} pour ${data.companyName}...`;
                        
                        const htmlContent = generateMultiPageHtml(data);
                        
                        if (i > 0) {
                            doc.addPage();
                        }
                        
                        const elementToRender = document.createElement('div');
                        elementToRender.className = 'complement-pdf-render-area';
                        elementToRender.innerHTML = htmlContent;
                        document.body.appendChild(elementToRender);
                        
                        const content = elementToRender.querySelector('.complement-pdf-content');
                        
                        const canvas = await html2canvas(content, { 
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            width: content.scrollWidth,
                            height: content.scrollHeight,
                            windowWidth: content.scrollWidth,
                            windowHeight: content.scrollHeight
                        });
                        
                        const imgData = canvas.toDataURL('image/png');
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const pageHeight = doc.internal.pageSize.getHeight();
                        const imgHeight = (canvas.height * pageWidth) / canvas.width;
                        
                        doc.addImage(imgData, 'PNG', 0, 0, pageWidth, imgHeight);
                        
                        document.body.removeChild(elementToRender);
                    }
                    
                    doc.save(`demandes_complement_${commonData.refNumber.replace(/[\/\\?%*:|"<>]/g, '-')}.pdf`);
                    statusMultiDiv.textContent = 'PDF généré avec succès !';
                } catch (error) {
                    console.error('Erreur lors de la génération du PDF multi-pages :', error);
                    statusMultiDiv.textContent = 'Erreur lors de la génération du PDF.';
                }
            }
            
            async function generateSinglePagePDF() {
                const companyName = document.getElementById('singleCompanyName').value.trim();
                const refNumber = document.getElementById('singleRefNumber').value.trim();
                const offerType = document.getElementById('singleOfferType').value;
                const pricingType = document.getElementById('pricingType').value;
                const offerObject = document.getElementById('singleOfferObject').value.trim();
                const note = document.getElementById('singleNote').value.trim();
                
                if (!companyName || !refNumber || !offerObject) {
                    alert('Veuillez remplir tous les champs obligatoires (Nom de la société, Numéro de référence, Objet).');
                    return;
                }
                
                const conditionInputs = document.querySelectorAll('#singleConditionsContainer .condition-input');
                const conditions = Array.from(conditionInputs)
                    .map(input => input.value.trim())
                    .filter(condition => condition);
                
                if (conditions.length === 0) {
                    alert('Veuillez saisir au moins une condition.');
                    return;
                }
                
                statusSingleDiv.textContent = 'Génération du PDF en cours... Veuillez patienter.';
                
                const data = {
                    companyName,
                    refNumber,
                    offerType,
                    pricingType,
                    offerObject,
                    conditions,
                    note
                };
                
                const htmlContent = generateSinglePageHtml(data);
                const fileName = `Complement_dossier_${companyName.replace(/ /g, '_')}_${refNumber.replace(/\//g, '-')}.pdf`;
                
                try {
                    await generatePDFFromHtml(htmlContent, fileName);
                    statusSingleDiv.textContent = 'PDF généré avec succès !';
                } catch (error) {
                    console.error('Erreur lors de la génération du PDF :', error);
                    statusSingleDiv.textContent = 'Erreur lors de la génération du PDF.';
                }
            }
            
            // --- INITIALISATION & ÉCOUTEURS D'ÉVÉNEMENTS ---
            
            multiLotBtn.addEventListener('click', function() {
                multiLotBtn.classList.add('active');
                singleLotBtn.classList.remove('active');
                multiLotSection.classList.remove('hidden');
                singleLotSection.classList.add('hidden');
            });
            
            singleLotBtn.addEventListener('click', function() {
                singleLotBtn.classList.add('active');
                multiLotBtn.classList.remove('active');
                singleLotSection.classList.remove('hidden');
                multiLotSection.classList.add('hidden');
            });
            
            addSocieteBtn.addEventListener('click', addSocieteRow);
            generateMultiBtn.addEventListener('click', generateMultiPagePDF);
            
            addConditionBtn.addEventListener('click', function() {
                addConditionField(singleConditionsContainer);
            });
            
            document.querySelectorAll('#singleConditionsContainer .remove-condition').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (singleConditionsContainer.querySelectorAll('.condition-item').length > 1) {
                        this.closest('.condition-item').remove();
                    } else {
                        alert('Vous devez avoir au moins une condition.');
                    }
                });
            });
            
            generateSingleBtn.addEventListener('click', generateSinglePagePDF);
            
            addSocieteRow();
        }
    </script>
</body>
</html>
